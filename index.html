<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="Go-json-rest : A quick and easy way to setup a RESTful JSON API">

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Go-json-rest</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/ant0ine/go-json-rest">View on GitHub</a>

          <h1 id="project_title">Go-json-rest</h1>
          <h2 id="project_tagline">A quick and easy way to setup a RESTful JSON API</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/ant0ine/go-json-rest/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/ant0ine/go-json-rest/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h1>
<a id="go-json-rest" class="anchor" href="#go-json-rest" aria-hidden="true"><span class="octicon octicon-link"></span></a>Go-Json-Rest</h1>

<p><em>A quick and easy way to setup a RESTful JSON API</em></p>

<p><a href="https://godoc.org/github.com/ant0ine/go-json-rest/rest"><img src="http://img.shields.io/badge/godoc-reference-blue.svg?style=flat" alt="godoc"></a> <a href="https://raw.githubusercontent.com/ant0ine/go-json-rest/master/LICENSE"><img src="http://img.shields.io/badge/license-MIT-red.svg?style=flat" alt="license"></a> <a href="https://travis-ci.org/ant0ine/go-json-rest"><img src="https://img.shields.io/travis/ant0ine/go-json-rest.svg?style=flat" alt="build"></a></p>

<p><strong>Go-Json-Rest</strong> is a thin layer on top of <code>net/http</code> that helps building RESTful JSON APIs easily. It provides fast URL routing using a Trie based implementation, helpers to deal with JSON requests and responses, and middlewares for additional functionalities like CORS, Auth, Gzip ...</p>

<h2>
<a id="table-of-content" class="anchor" href="#table-of-content" aria-hidden="true"><span class="octicon octicon-link"></span></a>Table of content</h2>

<ul>
<li><a href="#features">Features</a></li>
<li><a href="#install">Install</a></li>
<li><a href="#vendoring">Vendoring</a></li>
<li>
<a href="#examples">Examples</a>

<ul>
<li>
<a href="#basics">Basics</a>

<ul>
<li><a href="#hello-world">Hello World!</a></li>
<li><a href="#countries">Countries</a></li>
<li><a href="#users">Users</a></li>
<li><a href="#lookup">Lookup</a></li>
</ul>
</li>
<li>
<a href="#applications">Applications</a>

<ul>
<li><a href="#api-and-static-files">API and static files</a></li>
<li><a href="#gorm">GORM</a></li>
<li><a href="#cors">CORS</a></li>
<li><a href="#jsonp">JSONP</a></li>
<li><a href="#basic-auth">Basic Auth</a></li>
<li><a href="#status">Status</a></li>
<li><a href="#status-auth">Status Auth</a></li>
</ul>
</li>
<li>
<a href="#advanced">Advanced</a>

<ul>
<li><a href="#streaming">Streaming</a></li>
<li><a href="#non-json-payload">Non JSON payload</a></li>
<li><a href="#api-versioning">API Versioning</a></li>
<li><a href="#statsd">Statsd</a></li>
<li><a href="#newrelic">NewRelic</a></li>
<li><a href="#graceful-shutdown">Graceful Shutdown</a></li>
<li><a href="#spdy">SPDY</a></li>
<li><a href="#gae">Google App Engine</a></li>
<li><a href="#basic-auth-custom">Basic Auth Custom</a></li>
<li><a href="#cors-custom">CORS Custom</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#external-documentation">External Documentation</a></li>
<li><a href="#options">Options</a></li>
<li><a href="#version-2-release-notes">Version 2 release notes</a></li>
<li><a href="#migration-guide-from-v1-to-v2">Migration guide from v1 to v2</a></li>
<li><a href="#thanks">Thanks</a></li>
</ul>

<h2>
<a id="features" class="anchor" href="#features" aria-hidden="true"><span class="octicon octicon-link"></span></a>Features</h2>

<ul>
<li>Many examples.</li>
<li>Fast and scalable URL routing. It implements the classic route description syntax using a scalable trie data structure.</li>
<li>Use Middlewares in order to implement and extend the functionalities. (Logging, Gzip, CORS, Auth, ...)</li>
<li>Implemented as a <code>net/http</code> Handler. This standard interface allows combinations with other Handlers.</li>
<li>Test package to help writing tests for your API.</li>
<li>Monitoring statistics inspired by Memcached.</li>
</ul>

<h2>
<a id="install" class="anchor" href="#install" aria-hidden="true"><span class="octicon octicon-link"></span></a>Install</h2>

<p>This package is "go-gettable", just do:</p>

<pre><code>go get github.com/ant0ine/go-json-rest/rest
</code></pre>

<h2>
<a id="vendoring" class="anchor" href="#vendoring" aria-hidden="true"><span class="octicon octicon-link"></span></a>Vendoring</h2>

<p>The recommended way of using this library in your project is to use the <strong>"vendoring"</strong> method,
where this library code is copied in your repository at a specific revision.
<a href="http://nathany.com/go-packages/">This page</a> is a good summary of package management in Go.</p>

<h2>
<a id="examples" class="anchor" href="#examples" aria-hidden="true"><span class="octicon octicon-link"></span></a>Examples</h2>

<p>All the following examples can be found in dedicated examples repository: <a href="https://github.com/ant0ine/go-json-rest-examples">https://github.com/ant0ine/go-json-rest-examples</a></p>

<h3>
<a id="basics" class="anchor" href="#basics" aria-hidden="true"><span class="octicon octicon-link"></span></a>Basics</h3>

<p>First examples to try, as an introduction to go-json-rest.</p>

<h4>
<a id="hello-world" class="anchor" href="#hello-world" aria-hidden="true"><span class="octicon octicon-link"></span></a>Hello World!</h4>

<p>Tradition!</p>

<p>The curl demo:</p>

<div class="highlight highlight-sh"><pre>curl -i http://127.0.0.1:8080/message</pre></div>

<p>Go code:</p>

<div class="highlight highlight-go"><pre><span class="pl-k">package</span> main

<span class="pl-k">import</span> (
    <span class="pl-s1"><span class="pl-pds">"</span>github.com/ant0ine/go-json-rest/rest<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>log<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>net/http<span class="pl-pds">"</span></span>
)

<span class="pl-k">type</span> <span class="pl-v">Message</span> <span class="pl-st">struct</span> {
    <span class="pl-v">Body</span> <span class="pl-st">string</span>
}

<span class="pl-k">func</span> <span class="pl-en">main</span>() {
    <span class="pl-vo">handler</span> <span class="pl-k">:=</span> rest.<span class="pl-vo">ResourceHandler</span>{}
    <span class="pl-vo">err</span> <span class="pl-k">:=</span> handler.<span class="pl-s3">SetRoutes</span>(
        &amp;rest.<span class="pl-vo">Route</span>{<span class="pl-s1"><span class="pl-pds">"</span>GET<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>/message<span class="pl-pds">"</span></span>, <span class="pl-s3">func</span>(w rest.<span class="pl-vo">ResponseWriter</span>, req *rest.<span class="pl-vo">Request</span>) {
            w.<span class="pl-s3">WriteJson</span>(&amp;Message{
                Body: <span class="pl-s1"><span class="pl-pds">"</span>Hello World!<span class="pl-pds">"</span></span>,
            })
        }},
    )
    <span class="pl-k">if</span> err != <span class="pl-c1">nil</span> {
        log.<span class="pl-s3">Fatal</span>(err)
    }
    log.<span class="pl-s3">Fatal</span>(http.<span class="pl-s3">ListenAndServe</span>(<span class="pl-s1"><span class="pl-pds">"</span>:8080<span class="pl-pds">"</span></span>, &amp;handler))
}
</pre></div>

<h4>
<a id="countries" class="anchor" href="#countries" aria-hidden="true"><span class="octicon octicon-link"></span></a>Countries</h4>

<p>Demonstrate simple POST GET and DELETE operations</p>

<p>The curl demo:</p>

<pre><code>curl -i -d '{"Code":"FR","Name":"France"}' http://127.0.0.1:8080/countries
curl -i -d '{"Code":"US","Name":"United States"}' http://127.0.0.1:8080/countries
curl -i http://127.0.0.1:8080/countries/FR
curl -i http://127.0.0.1:8080/countries/US
curl -i http://127.0.0.1:8080/countries
curl -i -X DELETE http://127.0.0.1:8080/countries/FR
curl -i http://127.0.0.1:8080/countries
curl -i -X DELETE http://127.0.0.1:8080/countries/US
curl -i http://127.0.0.1:8080/countries
</code></pre>

<p>Go code:</p>

<div class="highlight highlight-go"><pre><span class="pl-k">package</span> main

<span class="pl-k">import</span> (
    <span class="pl-s1"><span class="pl-pds">"</span>github.com/ant0ine/go-json-rest/rest<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>log<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>net/http<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>sync<span class="pl-pds">"</span></span>
)

<span class="pl-k">func</span> <span class="pl-en">main</span>() {

    <span class="pl-vo">handler</span> <span class="pl-k">:=</span> rest.<span class="pl-vo">ResourceHandler</span>{
        EnableRelaxedContentType: <span class="pl-c1">true</span>,
    }
    <span class="pl-vo">err</span> <span class="pl-k">:=</span> handler.<span class="pl-s3">SetRoutes</span>(
        &amp;rest.<span class="pl-vo">Route</span>{<span class="pl-s1"><span class="pl-pds">"</span>GET<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>/countries<span class="pl-pds">"</span></span>, GetAllCountries},
        &amp;rest.<span class="pl-vo">Route</span>{<span class="pl-s1"><span class="pl-pds">"</span>POST<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>/countries<span class="pl-pds">"</span></span>, PostCountry},
        &amp;rest.<span class="pl-vo">Route</span>{<span class="pl-s1"><span class="pl-pds">"</span>GET<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>/countries/:code<span class="pl-pds">"</span></span>, GetCountry},
        &amp;rest.<span class="pl-vo">Route</span>{<span class="pl-s1"><span class="pl-pds">"</span>DELETE<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>/countries/:code<span class="pl-pds">"</span></span>, DeleteCountry},
    )
    <span class="pl-k">if</span> err != <span class="pl-c1">nil</span> {
        log.<span class="pl-s3">Fatal</span>(err)
    }
    log.<span class="pl-s3">Fatal</span>(http.<span class="pl-s3">ListenAndServe</span>(<span class="pl-s1"><span class="pl-pds">"</span>:8080<span class="pl-pds">"</span></span>, &amp;handler))
}

<span class="pl-k">type</span> <span class="pl-v">Country</span> <span class="pl-st">struct</span> {
    <span class="pl-v">Code</span> <span class="pl-st">string</span>
    <span class="pl-v">Name</span> <span class="pl-st">string</span>
}

<span class="pl-k">var</span> <span class="pl-vo">store</span> = <span class="pl-s">map</span>[<span class="pl-st">string</span>]*Country{}

<span class="pl-k">var</span> <span class="pl-vo">lock</span> = sync.<span class="pl-vo">RWMutex</span>{}

<span class="pl-k">func</span> <span class="pl-en">GetCountry</span>(<span class="pl-v">w</span> <span class="pl-v">rest</span>.<span class="pl-v">ResponseWriter</span>, <span class="pl-v">r</span> *<span class="pl-v">rest</span>.<span class="pl-v">Request</span>) {
    <span class="pl-vo">code</span> <span class="pl-k">:=</span> r.<span class="pl-s3">PathParam</span>(<span class="pl-s1"><span class="pl-pds">"</span>code<span class="pl-pds">"</span></span>)

    lock.<span class="pl-s3">RLock</span>()
    <span class="pl-k">var</span> <span class="pl-vo">country</span> *Country
    <span class="pl-k">if</span> store[code] != <span class="pl-c1">nil</span> {
        country = &amp;Country{}
        *country = *store[code]
    }
    lock.<span class="pl-s3">RUnlock</span>()

    <span class="pl-k">if</span> country == <span class="pl-c1">nil</span> {
        rest.<span class="pl-s3">NotFound</span>(w, r)
        <span class="pl-k">return</span>
    }
    w.<span class="pl-s3">WriteJson</span>(country)
}

<span class="pl-k">func</span> <span class="pl-en">GetAllCountries</span>(<span class="pl-v">w</span> <span class="pl-v">rest</span>.<span class="pl-v">ResponseWriter</span>, <span class="pl-v">r</span> *<span class="pl-v">rest</span>.<span class="pl-v">Request</span>) {
    lock.<span class="pl-s3">RLock</span>()
    <span class="pl-vo">countries</span> <span class="pl-k">:=</span> <span class="pl-s3">make</span>([]Country, <span class="pl-s3">len</span>(store))
    <span class="pl-vo">i</span> <span class="pl-k">:=</span> <span class="pl-c1">0</span>
    <span class="pl-k">for</span> <span class="pl-vo">_</span>, <span class="pl-vo">country</span> <span class="pl-k">:=</span> <span class="pl-k">range</span> store {
        countries[i] = *country
        i++
    }
    lock.<span class="pl-s3">RUnlock</span>()
    w.<span class="pl-s3">WriteJson</span>(&amp;countries)
}

<span class="pl-k">func</span> <span class="pl-en">PostCountry</span>(<span class="pl-v">w</span> <span class="pl-v">rest</span>.<span class="pl-v">ResponseWriter</span>, <span class="pl-v">r</span> *<span class="pl-v">rest</span>.<span class="pl-v">Request</span>) {
    <span class="pl-vo">country</span> <span class="pl-k">:=</span> Country{}
    <span class="pl-vo">err</span> <span class="pl-k">:=</span> r.<span class="pl-s3">DecodeJsonPayload</span>(&amp;country)
    <span class="pl-k">if</span> err != <span class="pl-c1">nil</span> {
        rest.<span class="pl-s3">Error</span>(w, err.<span class="pl-s3">Error</span>(), http.<span class="pl-vo">StatusInternalServerError</span>)
        <span class="pl-k">return</span>
    }
    <span class="pl-k">if</span> country.<span class="pl-vo">Code</span> == <span class="pl-s1"><span class="pl-pds">"</span><span class="pl-pds">"</span></span> {
        rest.<span class="pl-s3">Error</span>(w, <span class="pl-s1"><span class="pl-pds">"</span>country code required<span class="pl-pds">"</span></span>, <span class="pl-c1">400</span>)
        <span class="pl-k">return</span>
    }
    <span class="pl-k">if</span> country.<span class="pl-vo">Name</span> == <span class="pl-s1"><span class="pl-pds">"</span><span class="pl-pds">"</span></span> {
        rest.<span class="pl-s3">Error</span>(w, <span class="pl-s1"><span class="pl-pds">"</span>country name required<span class="pl-pds">"</span></span>, <span class="pl-c1">400</span>)
        <span class="pl-k">return</span>
    }
    lock.<span class="pl-s3">Lock</span>()
    store[country.<span class="pl-vo">Code</span>] = &amp;country
    lock.<span class="pl-s3">Unlock</span>()
    w.<span class="pl-s3">WriteJson</span>(&amp;country)
}

<span class="pl-k">func</span> <span class="pl-en">DeleteCountry</span>(<span class="pl-v">w</span> <span class="pl-v">rest</span>.<span class="pl-v">ResponseWriter</span>, <span class="pl-v">r</span> *<span class="pl-v">rest</span>.<span class="pl-v">Request</span>) {
    <span class="pl-vo">code</span> <span class="pl-k">:=</span> r.<span class="pl-s3">PathParam</span>(<span class="pl-s1"><span class="pl-pds">"</span>code<span class="pl-pds">"</span></span>)
    lock.<span class="pl-s3">Lock</span>()
    <span class="pl-s3">delete</span>(store, code)
    lock.<span class="pl-s3">Unlock</span>()
    w.<span class="pl-s3">WriteHeader</span>(http.<span class="pl-vo">StatusOK</span>)
}
</pre></div>

<h4>
<a id="users" class="anchor" href="#users" aria-hidden="true"><span class="octicon octicon-link"></span></a>Users</h4>

<p>Demonstrate how to use Method Values.</p>

<p>Method Values have been <a href="https://golang.org/doc/go1.1#method_values">introduced in Go 1.1</a>.</p>

<p>Until then <code>rest.RouteObjectMethod</code> was provided, this method is now deprecated.</p>

<p>This shows how to map a Route to a method of an instantiated object (eg: receiver of the method)</p>

<p>The curl demo:</p>

<pre><code>curl -i -d '{"Name":"Antoine"}' http://127.0.0.1:8080/users
curl -i http://127.0.0.1:8080/users/0
curl -i -X PUT -d '{"Name":"Antoine Imbert"}' http://127.0.0.1:8080/users/0
curl -i -X DELETE http://127.0.0.1:8080/users/0
curl -i http://127.0.0.1:8080/users
</code></pre>

<p>Go code:</p>

<div class="highlight highlight-go"><pre><span class="pl-k">package</span> main

<span class="pl-k">import</span> (
    <span class="pl-s1"><span class="pl-pds">"</span>fmt<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>github.com/ant0ine/go-json-rest/rest<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>log<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>net/http<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>sync<span class="pl-pds">"</span></span>
)

<span class="pl-k">func</span> <span class="pl-en">main</span>() {

    <span class="pl-vo">users</span> <span class="pl-k">:=</span> Users{
        Store: <span class="pl-s">map</span>[<span class="pl-st">string</span>]*User{},
    }

    <span class="pl-vo">handler</span> <span class="pl-k">:=</span> rest.<span class="pl-vo">ResourceHandler</span>{
        EnableRelaxedContentType: <span class="pl-c1">true</span>,
    }
    <span class="pl-vo">err</span> <span class="pl-k">:=</span> handler.<span class="pl-s3">SetRoutes</span>(
        &amp;rest.<span class="pl-vo">Route</span>{<span class="pl-s1"><span class="pl-pds">"</span>GET<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>/users<span class="pl-pds">"</span></span>, users.<span class="pl-vo">GetAllUsers</span>},
        &amp;rest.<span class="pl-vo">Route</span>{<span class="pl-s1"><span class="pl-pds">"</span>POST<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>/users<span class="pl-pds">"</span></span>, users.<span class="pl-vo">PostUser</span>},
        &amp;rest.<span class="pl-vo">Route</span>{<span class="pl-s1"><span class="pl-pds">"</span>GET<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>/users/:id<span class="pl-pds">"</span></span>, users.<span class="pl-vo">GetUser</span>},
        &amp;rest.<span class="pl-vo">Route</span>{<span class="pl-s1"><span class="pl-pds">"</span>PUT<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>/users/:id<span class="pl-pds">"</span></span>, users.<span class="pl-vo">PutUser</span>},
        &amp;rest.<span class="pl-vo">Route</span>{<span class="pl-s1"><span class="pl-pds">"</span>DELETE<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>/users/:id<span class="pl-pds">"</span></span>, users.<span class="pl-vo">DeleteUser</span>},
    )
    <span class="pl-k">if</span> err != <span class="pl-c1">nil</span> {
        log.<span class="pl-s3">Fatal</span>(err)
    }
    log.<span class="pl-s3">Fatal</span>(http.<span class="pl-s3">ListenAndServe</span>(<span class="pl-s1"><span class="pl-pds">"</span>:8080<span class="pl-pds">"</span></span>, &amp;handler))
}

<span class="pl-k">type</span> <span class="pl-v">User</span> <span class="pl-st">struct</span> {
    <span class="pl-v">Id</span>   <span class="pl-st">string</span>
    <span class="pl-v">Name</span> <span class="pl-st">string</span>
}

<span class="pl-k">type</span> <span class="pl-v">Users</span> <span class="pl-st">struct</span> {
    sync.<span class="pl-vo">RWMutex</span>
    <span class="pl-v">Store</span> <span class="pl-s">map</span>[<span class="pl-st">string</span>]*User
}

<span class="pl-k">func</span> <span class="pl-en">(<span class="pl-v">u</span> *<span class="pl-v">Users</span>) <span class="pl-en">GetAllUsers</span></span>(<span class="pl-v">w</span> <span class="pl-v">rest</span>.<span class="pl-v">ResponseWriter</span>, <span class="pl-v">r</span> *<span class="pl-v">rest</span>.<span class="pl-v">Request</span>) {
    u.<span class="pl-s3">RLock</span>()
    <span class="pl-vo">users</span> <span class="pl-k">:=</span> <span class="pl-s3">make</span>([]User, <span class="pl-s3">len</span>(u.<span class="pl-vo">Store</span>))
    <span class="pl-vo">i</span> <span class="pl-k">:=</span> <span class="pl-c1">0</span>
    <span class="pl-k">for</span> <span class="pl-vo">_</span>, <span class="pl-vo">user</span> <span class="pl-k">:=</span> <span class="pl-k">range</span> u.<span class="pl-vo">Store</span> {
        users[i] = *user
        i++
    }
    u.<span class="pl-s3">RUnlock</span>()
    w.<span class="pl-s3">WriteJson</span>(&amp;users)
}

<span class="pl-k">func</span> <span class="pl-en">(<span class="pl-v">u</span> *<span class="pl-v">Users</span>) <span class="pl-en">GetUser</span></span>(<span class="pl-v">w</span> <span class="pl-v">rest</span>.<span class="pl-v">ResponseWriter</span>, <span class="pl-v">r</span> *<span class="pl-v">rest</span>.<span class="pl-v">Request</span>) {
    <span class="pl-vo">id</span> <span class="pl-k">:=</span> r.<span class="pl-s3">PathParam</span>(<span class="pl-s1"><span class="pl-pds">"</span>id<span class="pl-pds">"</span></span>)
    u.<span class="pl-s3">RLock</span>()
    <span class="pl-k">var</span> <span class="pl-vo">user</span> *User
    <span class="pl-k">if</span> u.<span class="pl-vo">Store</span>[id] != <span class="pl-c1">nil</span> {
        user = &amp;User{}
        *user = *u.<span class="pl-vo">Store</span>[id]
    }
    u.<span class="pl-s3">RUnlock</span>()
    <span class="pl-k">if</span> user == <span class="pl-c1">nil</span> {
        rest.<span class="pl-s3">NotFound</span>(w, r)
        <span class="pl-k">return</span>
    }
    w.<span class="pl-s3">WriteJson</span>(user)
}

<span class="pl-k">func</span> <span class="pl-en">(<span class="pl-v">u</span> *<span class="pl-v">Users</span>) <span class="pl-en">PostUser</span></span>(<span class="pl-v">w</span> <span class="pl-v">rest</span>.<span class="pl-v">ResponseWriter</span>, <span class="pl-v">r</span> *<span class="pl-v">rest</span>.<span class="pl-v">Request</span>) {
    <span class="pl-vo">user</span> <span class="pl-k">:=</span> User{}
    <span class="pl-vo">err</span> <span class="pl-k">:=</span> r.<span class="pl-s3">DecodeJsonPayload</span>(&amp;user)
    <span class="pl-k">if</span> err != <span class="pl-c1">nil</span> {
        rest.<span class="pl-s3">Error</span>(w, err.<span class="pl-s3">Error</span>(), http.<span class="pl-vo">StatusInternalServerError</span>)
        <span class="pl-k">return</span>
    }
    u.<span class="pl-s3">Lock</span>()
    <span class="pl-vo">id</span> <span class="pl-k">:=</span> fmt.<span class="pl-s3">Sprintf</span>(<span class="pl-s1"><span class="pl-pds">"</span><span class="pl-c1">%d</span><span class="pl-pds">"</span></span>, <span class="pl-s3">len</span>(u.<span class="pl-vo">Store</span>)) <span class="pl-c">// stupid</span>
    user.<span class="pl-vo">Id</span> = id
    u.<span class="pl-vo">Store</span>[id] = &amp;user
    u.<span class="pl-s3">Unlock</span>()
    w.<span class="pl-s3">WriteJson</span>(&amp;user)
}

<span class="pl-k">func</span> <span class="pl-en">(<span class="pl-v">u</span> *<span class="pl-v">Users</span>) <span class="pl-en">PutUser</span></span>(<span class="pl-v">w</span> <span class="pl-v">rest</span>.<span class="pl-v">ResponseWriter</span>, <span class="pl-v">r</span> *<span class="pl-v">rest</span>.<span class="pl-v">Request</span>) {
    <span class="pl-vo">id</span> <span class="pl-k">:=</span> r.<span class="pl-s3">PathParam</span>(<span class="pl-s1"><span class="pl-pds">"</span>id<span class="pl-pds">"</span></span>)
    u.<span class="pl-s3">Lock</span>()
    <span class="pl-k">if</span> u.<span class="pl-vo">Store</span>[id] == <span class="pl-c1">nil</span> {
        rest.<span class="pl-s3">NotFound</span>(w, r)
        u.<span class="pl-s3">Unlock</span>()
        <span class="pl-k">return</span>
    }
    <span class="pl-vo">user</span> <span class="pl-k">:=</span> User{}
    <span class="pl-vo">err</span> <span class="pl-k">:=</span> r.<span class="pl-s3">DecodeJsonPayload</span>(&amp;user)
    <span class="pl-k">if</span> err != <span class="pl-c1">nil</span> {
        rest.<span class="pl-s3">Error</span>(w, err.<span class="pl-s3">Error</span>(), http.<span class="pl-vo">StatusInternalServerError</span>)
        u.<span class="pl-s3">Unlock</span>()
        <span class="pl-k">return</span>
    }
    user.<span class="pl-vo">Id</span> = id
    u.<span class="pl-vo">Store</span>[id] = &amp;user
    u.<span class="pl-s3">Unlock</span>()
    w.<span class="pl-s3">WriteJson</span>(&amp;user)
}

<span class="pl-k">func</span> <span class="pl-en">(<span class="pl-v">u</span> *<span class="pl-v">Users</span>) <span class="pl-en">DeleteUser</span></span>(<span class="pl-v">w</span> <span class="pl-v">rest</span>.<span class="pl-v">ResponseWriter</span>, <span class="pl-v">r</span> *<span class="pl-v">rest</span>.<span class="pl-v">Request</span>) {
    <span class="pl-vo">id</span> <span class="pl-k">:=</span> r.<span class="pl-s3">PathParam</span>(<span class="pl-s1"><span class="pl-pds">"</span>id<span class="pl-pds">"</span></span>)
    u.<span class="pl-s3">Lock</span>()
    <span class="pl-s3">delete</span>(u.<span class="pl-vo">Store</span>, id)
    u.<span class="pl-s3">Unlock</span>()
    w.<span class="pl-s3">WriteHeader</span>(http.<span class="pl-vo">StatusOK</span>)
}
</pre></div>

<h4>
<a id="lookup" class="anchor" href="#lookup" aria-hidden="true"><span class="octicon octicon-link"></span></a>Lookup</h4>

<p>Demonstrate how to use the relaxed placeholder (notation #paramName).
This placeholder matches everything until the first <code>/</code>, including <code>.</code></p>

<p>The curl demo:</p>

<pre><code>curl -i http://127.0.0.1:8080/lookup/google.com
curl -i http://127.0.0.1:8080/lookup/notadomain
</code></pre>

<p>Go code:</p>

<div class="highlight highlight-go"><pre><span class="pl-k">package</span> main

<span class="pl-k">import</span> (
    <span class="pl-s1"><span class="pl-pds">"</span>github.com/ant0ine/go-json-rest/rest<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>log<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>net<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>net/http<span class="pl-pds">"</span></span>
)

<span class="pl-k">type</span> <span class="pl-v">Message</span> <span class="pl-st">struct</span> {
    <span class="pl-v">Body</span> <span class="pl-st">string</span>
}

<span class="pl-k">func</span> <span class="pl-en">main</span>() {
    <span class="pl-vo">handler</span> <span class="pl-k">:=</span> rest.<span class="pl-vo">ResourceHandler</span>{}
    <span class="pl-vo">err</span> <span class="pl-k">:=</span> handler.<span class="pl-s3">SetRoutes</span>(
        &amp;rest.<span class="pl-vo">Route</span>{<span class="pl-s1"><span class="pl-pds">"</span>GET<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>/lookup/#host<span class="pl-pds">"</span></span>, <span class="pl-s3">func</span>(w rest.<span class="pl-vo">ResponseWriter</span>, req *rest.<span class="pl-vo">Request</span>) {
            <span class="pl-vo">ip</span>, <span class="pl-vo">err</span> <span class="pl-k">:=</span> net.<span class="pl-s3">LookupIP</span>(req.<span class="pl-s3">PathParam</span>(<span class="pl-s1"><span class="pl-pds">"</span>host<span class="pl-pds">"</span></span>))
            <span class="pl-k">if</span> err != <span class="pl-c1">nil</span> {
                rest.<span class="pl-s3">Error</span>(w, err.<span class="pl-s3">Error</span>(), http.<span class="pl-vo">StatusInternalServerError</span>)
                <span class="pl-k">return</span>
            }
            w.<span class="pl-s3">WriteJson</span>(&amp;ip)
        }},
    )
    <span class="pl-k">if</span> err != <span class="pl-c1">nil</span> {
        log.<span class="pl-s3">Fatal</span>(err)
    }
    log.<span class="pl-s3">Fatal</span>(http.<span class="pl-s3">ListenAndServe</span>(<span class="pl-s1"><span class="pl-pds">"</span>:8080<span class="pl-pds">"</span></span>, &amp;handler))
}
</pre></div>

<h3>
<a id="applications" class="anchor" href="#applications" aria-hidden="true"><span class="octicon octicon-link"></span></a>Applications</h3>

<p>Common use cases, found in many applications.</p>

<h4>
<a id="api-and-static-files" class="anchor" href="#api-and-static-files" aria-hidden="true"><span class="octicon octicon-link"></span></a>API and static files</h4>

<p>Combine Go-Json-Rest with other handlers.</p>

<p><code>rest.ResourceHandler</code> is a valid <code>http.Handler</code>, and can be combined with other handlers.
In this example the ResourceHandler is used under the <code>/api/</code> prefix, while a FileServer is instantiated under the <code>/static/</code> prefix.</p>

<p>The curl demo:</p>

<pre><code>curl -i http://127.0.0.1:8080/api/message
curl -i http://127.0.0.1:8080/static/main.go
</code></pre>

<p>Go code:</p>

<div class="highlight highlight-go"><pre><span class="pl-k">package</span> main

<span class="pl-k">import</span> (
    <span class="pl-s1"><span class="pl-pds">"</span>github.com/ant0ine/go-json-rest/rest<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>log<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>net/http<span class="pl-pds">"</span></span>
)

<span class="pl-k">func</span> <span class="pl-en">main</span>() {
    <span class="pl-vo">handler</span> <span class="pl-k">:=</span> rest.<span class="pl-vo">ResourceHandler</span>{}
    <span class="pl-vo">err</span> <span class="pl-k">:=</span> handler.<span class="pl-s3">SetRoutes</span>(
        &amp;rest.<span class="pl-vo">Route</span>{<span class="pl-s1"><span class="pl-pds">"</span>GET<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>/message<span class="pl-pds">"</span></span>, <span class="pl-s3">func</span>(w rest.<span class="pl-vo">ResponseWriter</span>, req *rest.<span class="pl-vo">Request</span>) {
            w.<span class="pl-s3">WriteJson</span>(<span class="pl-s">map</span>[<span class="pl-st">string</span>]<span class="pl-st">string</span>{<span class="pl-s1"><span class="pl-pds">"</span>Body<span class="pl-pds">"</span></span>: <span class="pl-s1"><span class="pl-pds">"</span>Hello World!<span class="pl-pds">"</span></span>})
        }},
    )
    <span class="pl-k">if</span> err != <span class="pl-c1">nil</span> {
        log.<span class="pl-s3">Fatal</span>(err)
    }
    http.<span class="pl-s3">Handle</span>(<span class="pl-s1"><span class="pl-pds">"</span>/api/<span class="pl-pds">"</span></span>, http.<span class="pl-s3">StripPrefix</span>(<span class="pl-s1"><span class="pl-pds">"</span>/api<span class="pl-pds">"</span></span>, &amp;handler))

    http.<span class="pl-s3">Handle</span>(<span class="pl-s1"><span class="pl-pds">"</span>/static/<span class="pl-pds">"</span></span>, http.<span class="pl-s3">StripPrefix</span>(<span class="pl-s1"><span class="pl-pds">"</span>/static<span class="pl-pds">"</span></span>, http.<span class="pl-s3">FileServer</span>(http.<span class="pl-s3">Dir</span>(<span class="pl-s1"><span class="pl-pds">"</span>.<span class="pl-pds">"</span></span>))))

    log.<span class="pl-s3">Fatal</span>(http.<span class="pl-s3">ListenAndServe</span>(<span class="pl-s1"><span class="pl-pds">"</span>:8080<span class="pl-pds">"</span></span>, <span class="pl-c1">nil</span>))
}
</pre></div>

<h4>
<a id="gorm" class="anchor" href="#gorm" aria-hidden="true"><span class="octicon octicon-link"></span></a>GORM</h4>

<p>Demonstrate basic CRUD operation using a store based on MySQL and GORM</p>

<p><a href="https://github.com/jinzhu/gorm">GORM</a> is simple ORM library for Go.
In this example the same struct is used both as the GORM model and as the JSON model.</p>

<p>The curl demo:</p>

<pre><code>curl -i -d '{"Message":"this is a test"}' http://127.0.0.1:8080/reminders
curl -i http://127.0.0.1:8080/reminders/1
curl -i http://127.0.0.1:8080/reminders
curl -i -X PUT -d '{"Message":"is updated"}' http://127.0.0.1:8080/reminders/1
curl -i -X DELETE http://127.0.0.1:8080/reminders/1
</code></pre>

<p>Go code:</p>

<div class="highlight highlight-go"><pre><span class="pl-k">package</span> main

<span class="pl-k">import</span> (
    <span class="pl-s1"><span class="pl-pds">"</span>github.com/ant0ine/go-json-rest/rest<span class="pl-pds">"</span></span>
    _ <span class="pl-s1"><span class="pl-pds">"</span>github.com/go-sql-driver/mysql<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>github.com/jinzhu/gorm<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>log<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>net/http<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>time<span class="pl-pds">"</span></span>
)

<span class="pl-k">func</span> <span class="pl-en">main</span>() {

    <span class="pl-vo">api</span> <span class="pl-k">:=</span> Api{}
    api.<span class="pl-s3">InitDB</span>()
    api.<span class="pl-s3">InitSchema</span>()

    <span class="pl-vo">handler</span> <span class="pl-k">:=</span> rest.<span class="pl-vo">ResourceHandler</span>{
        EnableRelaxedContentType: <span class="pl-c1">true</span>,
    }
    <span class="pl-vo">err</span> <span class="pl-k">:=</span> handler.<span class="pl-s3">SetRoutes</span>(
        &amp;rest.<span class="pl-vo">Route</span>{<span class="pl-s1"><span class="pl-pds">"</span>GET<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>/reminders<span class="pl-pds">"</span></span>, api.<span class="pl-vo">GetAllReminders</span>},
        &amp;rest.<span class="pl-vo">Route</span>{<span class="pl-s1"><span class="pl-pds">"</span>POST<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>/reminders<span class="pl-pds">"</span></span>, api.<span class="pl-vo">PostReminder</span>},
        &amp;rest.<span class="pl-vo">Route</span>{<span class="pl-s1"><span class="pl-pds">"</span>GET<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>/reminders/:id<span class="pl-pds">"</span></span>, api.<span class="pl-vo">GetReminder</span>},
        &amp;rest.<span class="pl-vo">Route</span>{<span class="pl-s1"><span class="pl-pds">"</span>PUT<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>/reminders/:id<span class="pl-pds">"</span></span>, api.<span class="pl-vo">PutReminder</span>},
        &amp;rest.<span class="pl-vo">Route</span>{<span class="pl-s1"><span class="pl-pds">"</span>DELETE<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>/reminders/:id<span class="pl-pds">"</span></span>, api.<span class="pl-vo">DeleteReminder</span>},
    )
    <span class="pl-k">if</span> err != <span class="pl-c1">nil</span> {
        log.<span class="pl-s3">Fatal</span>(err)
    }
    log.<span class="pl-s3">Fatal</span>(http.<span class="pl-s3">ListenAndServe</span>(<span class="pl-s1"><span class="pl-pds">"</span>:8080<span class="pl-pds">"</span></span>, &amp;handler))
}

<span class="pl-k">type</span> <span class="pl-v">Reminder</span> <span class="pl-st">struct</span> {
    <span class="pl-v">Id</span>        <span class="pl-st">int64</span>     <span class="pl-s1"><span class="pl-pds">`</span>json:"id"<span class="pl-pds">`</span></span>
    <span class="pl-v">Message</span>   <span class="pl-st">string</span>    <span class="pl-s1"><span class="pl-pds">`</span>sql:"size:1024" json:"message"<span class="pl-pds">`</span></span>
    <span class="pl-v">CreatedAt</span> time.<span class="pl-vo">Time</span> <span class="pl-s1"><span class="pl-pds">`</span>json:"createdAt"<span class="pl-pds">`</span></span>
    <span class="pl-v">UpdatedAt</span> time.<span class="pl-vo">Time</span> <span class="pl-s1"><span class="pl-pds">`</span>json:"updatedAt"<span class="pl-pds">`</span></span>
    <span class="pl-v">DeletedAt</span> time.<span class="pl-vo">Time</span> <span class="pl-s1"><span class="pl-pds">`</span>json:"-"<span class="pl-pds">`</span></span>
}

<span class="pl-k">type</span> <span class="pl-v">Api</span> <span class="pl-st">struct</span> {
    <span class="pl-v">DB</span> gorm.<span class="pl-vo">DB</span>
}

<span class="pl-k">func</span> <span class="pl-en">(<span class="pl-v">api</span> *<span class="pl-v">Api</span>) <span class="pl-en">InitDB</span></span>() {
    <span class="pl-k">var</span> <span class="pl-vo">err</span> <span class="pl-st">error</span>
    api.<span class="pl-vo">DB</span>, err = gorm.<span class="pl-s3">Open</span>(<span class="pl-s1"><span class="pl-pds">"</span>mysql<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>gorm:gorm@/gorm?charset=utf8&amp;parseTime=True<span class="pl-pds">"</span></span>)
    <span class="pl-k">if</span> err != <span class="pl-c1">nil</span> {
        log.<span class="pl-s3">Fatalf</span>(<span class="pl-s1"><span class="pl-pds">"</span>Got error when connect database, the error is '<span class="pl-c1">%v</span>'<span class="pl-pds">"</span></span>, err)
    }
    api.<span class="pl-vo">DB</span>.<span class="pl-s3">LogMode</span>(<span class="pl-c1">true</span>)
}

<span class="pl-k">func</span> <span class="pl-en">(<span class="pl-v">api</span> *<span class="pl-v">Api</span>) <span class="pl-en">InitSchema</span></span>() {
    api.<span class="pl-vo">DB</span>.<span class="pl-s3">AutoMigrate</span>(&amp;Reminder{})
}

<span class="pl-k">func</span> <span class="pl-en">(<span class="pl-v">api</span> *<span class="pl-v">Api</span>) <span class="pl-en">GetAllReminders</span></span>(<span class="pl-v">w</span> <span class="pl-v">rest</span>.<span class="pl-v">ResponseWriter</span>, <span class="pl-v">r</span> *<span class="pl-v">rest</span>.<span class="pl-v">Request</span>) {
    <span class="pl-vo">reminders</span> <span class="pl-k">:=</span> []Reminder{}
    api.<span class="pl-vo">DB</span>.<span class="pl-s3">Find</span>(&amp;reminders)
    w.<span class="pl-s3">WriteJson</span>(&amp;reminders)
}

<span class="pl-k">func</span> <span class="pl-en">(<span class="pl-v">api</span> *<span class="pl-v">Api</span>) <span class="pl-en">GetReminder</span></span>(<span class="pl-v">w</span> <span class="pl-v">rest</span>.<span class="pl-v">ResponseWriter</span>, <span class="pl-v">r</span> *<span class="pl-v">rest</span>.<span class="pl-v">Request</span>) {
    <span class="pl-vo">id</span> <span class="pl-k">:=</span> r.<span class="pl-s3">PathParam</span>(<span class="pl-s1"><span class="pl-pds">"</span>id<span class="pl-pds">"</span></span>)
    <span class="pl-vo">reminder</span> <span class="pl-k">:=</span> Reminder{}
    <span class="pl-k">if</span> api.<span class="pl-vo">DB</span>.<span class="pl-s3">First</span>(&amp;reminder, id).<span class="pl-vo">Error</span> != <span class="pl-c1">nil</span> {
        rest.<span class="pl-s3">NotFound</span>(w, r)
        <span class="pl-k">return</span>
    }
    w.<span class="pl-s3">WriteJson</span>(&amp;reminder)
}

<span class="pl-k">func</span> <span class="pl-en">(<span class="pl-v">api</span> *<span class="pl-v">Api</span>) <span class="pl-en">PostReminder</span></span>(<span class="pl-v">w</span> <span class="pl-v">rest</span>.<span class="pl-v">ResponseWriter</span>, <span class="pl-v">r</span> *<span class="pl-v">rest</span>.<span class="pl-v">Request</span>) {
    <span class="pl-vo">reminder</span> <span class="pl-k">:=</span> Reminder{}
    <span class="pl-k">if</span> <span class="pl-vo">err</span> <span class="pl-k">:=</span> r.<span class="pl-s3">DecodeJsonPayload</span>(&amp;reminder); err != <span class="pl-c1">nil</span> {
        rest.<span class="pl-s3">Error</span>(w, err.<span class="pl-s3">Error</span>(), http.<span class="pl-vo">StatusInternalServerError</span>)
        <span class="pl-k">return</span>
    }
    <span class="pl-k">if</span> <span class="pl-vo">err</span> <span class="pl-k">:=</span> api.<span class="pl-vo">DB</span>.<span class="pl-s3">Save</span>(&amp;reminder).<span class="pl-vo">Error</span>; err != <span class="pl-c1">nil</span> {
        rest.<span class="pl-s3">Error</span>(w, err.<span class="pl-s3">Error</span>(), http.<span class="pl-vo">StatusInternalServerError</span>)
        <span class="pl-k">return</span>
    }
    w.<span class="pl-s3">WriteJson</span>(&amp;reminder)
}

<span class="pl-k">func</span> <span class="pl-en">(<span class="pl-v">api</span> *<span class="pl-v">Api</span>) <span class="pl-en">PutReminder</span></span>(<span class="pl-v">w</span> <span class="pl-v">rest</span>.<span class="pl-v">ResponseWriter</span>, <span class="pl-v">r</span> *<span class="pl-v">rest</span>.<span class="pl-v">Request</span>) {

    <span class="pl-vo">id</span> <span class="pl-k">:=</span> r.<span class="pl-s3">PathParam</span>(<span class="pl-s1"><span class="pl-pds">"</span>id<span class="pl-pds">"</span></span>)
    <span class="pl-vo">reminder</span> <span class="pl-k">:=</span> Reminder{}
    <span class="pl-k">if</span> api.<span class="pl-vo">DB</span>.<span class="pl-s3">First</span>(&amp;reminder, id).<span class="pl-vo">Error</span> != <span class="pl-c1">nil</span> {
        rest.<span class="pl-s3">NotFound</span>(w, r)
        <span class="pl-k">return</span>
    }

    <span class="pl-vo">updated</span> <span class="pl-k">:=</span> Reminder{}
    <span class="pl-k">if</span> <span class="pl-vo">err</span> <span class="pl-k">:=</span> r.<span class="pl-s3">DecodeJsonPayload</span>(&amp;updated); err != <span class="pl-c1">nil</span> {
        rest.<span class="pl-s3">Error</span>(w, err.<span class="pl-s3">Error</span>(), http.<span class="pl-vo">StatusInternalServerError</span>)
        <span class="pl-k">return</span>
    }

    reminder.<span class="pl-vo">Message</span> = updated.<span class="pl-vo">Message</span>

    <span class="pl-k">if</span> <span class="pl-vo">err</span> <span class="pl-k">:=</span> api.<span class="pl-vo">DB</span>.<span class="pl-s3">Save</span>(&amp;reminder).<span class="pl-vo">Error</span>; err != <span class="pl-c1">nil</span> {
        rest.<span class="pl-s3">Error</span>(w, err.<span class="pl-s3">Error</span>(), http.<span class="pl-vo">StatusInternalServerError</span>)
        <span class="pl-k">return</span>
    }
    w.<span class="pl-s3">WriteJson</span>(&amp;reminder)
}

<span class="pl-k">func</span> <span class="pl-en">(<span class="pl-v">api</span> *<span class="pl-v">Api</span>) <span class="pl-en">DeleteReminder</span></span>(<span class="pl-v">w</span> <span class="pl-v">rest</span>.<span class="pl-v">ResponseWriter</span>, <span class="pl-v">r</span> *<span class="pl-v">rest</span>.<span class="pl-v">Request</span>) {
    <span class="pl-vo">id</span> <span class="pl-k">:=</span> r.<span class="pl-s3">PathParam</span>(<span class="pl-s1"><span class="pl-pds">"</span>id<span class="pl-pds">"</span></span>)
    <span class="pl-vo">reminder</span> <span class="pl-k">:=</span> Reminder{}
    <span class="pl-k">if</span> api.<span class="pl-vo">DB</span>.<span class="pl-s3">First</span>(&amp;reminder, id).<span class="pl-vo">Error</span> != <span class="pl-c1">nil</span> {
        rest.<span class="pl-s3">NotFound</span>(w, r)
        <span class="pl-k">return</span>
    }
    <span class="pl-k">if</span> <span class="pl-vo">err</span> <span class="pl-k">:=</span> api.<span class="pl-vo">DB</span>.<span class="pl-s3">Delete</span>(&amp;reminder).<span class="pl-vo">Error</span>; err != <span class="pl-c1">nil</span> {
        rest.<span class="pl-s3">Error</span>(w, err.<span class="pl-s3">Error</span>(), http.<span class="pl-vo">StatusInternalServerError</span>)
        <span class="pl-k">return</span>
    }
    w.<span class="pl-s3">WriteHeader</span>(http.<span class="pl-vo">StatusOK</span>)
}
</pre></div>

<h4>
<a id="cors" class="anchor" href="#cors" aria-hidden="true"><span class="octicon octicon-link"></span></a>CORS</h4>

<p>Demonstrate how to setup CorsMiddleware around all the API endpoints.</p>

<p>The curl demo:</p>

<pre><code>curl -i http://127.0.0.1:8080/countries
</code></pre>

<p>Go code:</p>

<div class="highlight highlight-go"><pre><span class="pl-k">package</span> main

<span class="pl-k">import</span> (
    <span class="pl-s1"><span class="pl-pds">"</span>github.com/ant0ine/go-json-rest/rest<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>log<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>net/http<span class="pl-pds">"</span></span>
)

<span class="pl-k">func</span> <span class="pl-en">main</span>() {

    <span class="pl-vo">handler</span> <span class="pl-k">:=</span> rest.<span class="pl-vo">ResourceHandler</span>{
        PreRoutingMiddlewares: []rest.<span class="pl-vo">Middleware</span>{
            &amp;rest.<span class="pl-vo">CorsMiddleware</span>{
                RejectNonCorsRequests: <span class="pl-c1">false</span>,
                OriginValidator: <span class="pl-s3">func</span>(origin <span class="pl-st">string</span>, request *rest.<span class="pl-vo">Request</span>) <span class="pl-st">bool</span> {
                    <span class="pl-k">return</span> origin == <span class="pl-s1"><span class="pl-pds">"</span>http://my.other.host<span class="pl-pds">"</span></span>
                },
                AllowedMethods: []<span class="pl-st">string</span>{<span class="pl-s1"><span class="pl-pds">"</span>GET<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>POST<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>PUT<span class="pl-pds">"</span></span>},
                AllowedHeaders: []<span class="pl-st">string</span>{
                    <span class="pl-s1"><span class="pl-pds">"</span>Accept<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>Content-Type<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>X-Custom-Header<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>Origin<span class="pl-pds">"</span></span>},
                AccessControlAllowCredentials: <span class="pl-c1">true</span>,
                AccessControlMaxAge:           <span class="pl-c1">3600</span>,
            },
        },
    }
    <span class="pl-vo">err</span> <span class="pl-k">:=</span> handler.<span class="pl-s3">SetRoutes</span>(
        &amp;rest.<span class="pl-vo">Route</span>{<span class="pl-s1"><span class="pl-pds">"</span>GET<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>/countries<span class="pl-pds">"</span></span>, GetAllCountries},
    )
    <span class="pl-k">if</span> err != <span class="pl-c1">nil</span> {
        log.<span class="pl-s3">Fatal</span>(err)
    }
    log.<span class="pl-s3">Fatal</span>(http.<span class="pl-s3">ListenAndServe</span>(<span class="pl-s1"><span class="pl-pds">"</span>:8080<span class="pl-pds">"</span></span>, &amp;handler))
}

<span class="pl-k">type</span> <span class="pl-v">Country</span> <span class="pl-st">struct</span> {
    <span class="pl-v">Code</span> <span class="pl-st">string</span>
    <span class="pl-v">Name</span> <span class="pl-st">string</span>
}

<span class="pl-k">func</span> <span class="pl-en">GetAllCountries</span>(<span class="pl-v">w</span> <span class="pl-v">rest</span>.<span class="pl-v">ResponseWriter</span>, <span class="pl-v">r</span> *<span class="pl-v">rest</span>.<span class="pl-v">Request</span>) {
    w.<span class="pl-s3">WriteJson</span>(
        []Country{
            Country{
                Code: <span class="pl-s1"><span class="pl-pds">"</span>FR<span class="pl-pds">"</span></span>,
                Name: <span class="pl-s1"><span class="pl-pds">"</span>France<span class="pl-pds">"</span></span>,
            },
            Country{
                Code: <span class="pl-s1"><span class="pl-pds">"</span>US<span class="pl-pds">"</span></span>,
                Name: <span class="pl-s1"><span class="pl-pds">"</span>United States<span class="pl-pds">"</span></span>,
            },
        },
    )
}
</pre></div>

<h4>
<a id="jsonp" class="anchor" href="#jsonp" aria-hidden="true"><span class="octicon octicon-link"></span></a>JSONP</h4>

<p>Demonstrate how to use the JSONP middleware.</p>

<p>The curl demo:</p>

<div class="highlight highlight-sh"><pre>curl -i http://127.0.0.1:8080/message
curl -i http://127.0.0.1:8080/message<span class="pl-k">?</span>cb=parseResponse</pre></div>

<p>Go code:</p>

<div class="highlight highlight-go"><pre><span class="pl-k">package</span> main

<span class="pl-k">import</span> (
    <span class="pl-s1"><span class="pl-pds">"</span>github.com/ant0ine/go-json-rest/rest<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>log<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>net/http<span class="pl-pds">"</span></span>
)

<span class="pl-k">func</span> <span class="pl-en">main</span>() {
    <span class="pl-vo">handler</span> <span class="pl-k">:=</span> rest.<span class="pl-vo">ResourceHandler</span>{
        PreRoutingMiddlewares: []rest.<span class="pl-vo">Middleware</span>{
            &amp;rest.<span class="pl-vo">JsonpMiddleware</span>{
                CallbackNameKey: <span class="pl-s1"><span class="pl-pds">"</span>cb<span class="pl-pds">"</span></span>,
            },
        },
    }
    <span class="pl-vo">err</span> <span class="pl-k">:=</span> handler.<span class="pl-s3">SetRoutes</span>(
        &amp;rest.<span class="pl-vo">Route</span>{<span class="pl-s1"><span class="pl-pds">"</span>GET<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>/message<span class="pl-pds">"</span></span>, <span class="pl-s3">func</span>(w rest.<span class="pl-vo">ResponseWriter</span>, req *rest.<span class="pl-vo">Request</span>) {
            w.<span class="pl-s3">WriteJson</span>(<span class="pl-s">map</span>[<span class="pl-st">string</span>]<span class="pl-st">string</span>{<span class="pl-s1"><span class="pl-pds">"</span>Body<span class="pl-pds">"</span></span>: <span class="pl-s1"><span class="pl-pds">"</span>Hello World!<span class="pl-pds">"</span></span>})
        }},
    )
    <span class="pl-k">if</span> err != <span class="pl-c1">nil</span> {
        log.<span class="pl-s3">Fatal</span>(err)
    }
    log.<span class="pl-s3">Fatal</span>(http.<span class="pl-s3">ListenAndServe</span>(<span class="pl-s1"><span class="pl-pds">"</span>:8080<span class="pl-pds">"</span></span>, &amp;handler))
}
</pre></div>

<h4>
<a id="basic-auth" class="anchor" href="#basic-auth" aria-hidden="true"><span class="octicon octicon-link"></span></a>Basic Auth</h4>

<p>Demonstrate how to setup AuthBasicMiddleware as a pre-routing middleware.</p>

<p>The curl demo:</p>

<pre><code>curl -i http://127.0.0.1:8080/countries
curl -i -u admin:admin http://127.0.0.1:8080/countries
</code></pre>

<p>Go code:</p>

<div class="highlight highlight-go"><pre><span class="pl-k">package</span> main

<span class="pl-k">import</span> (
    <span class="pl-s1"><span class="pl-pds">"</span>github.com/ant0ine/go-json-rest/rest<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>log<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>net/http<span class="pl-pds">"</span></span>
)

<span class="pl-k">func</span> <span class="pl-en">main</span>() {

    <span class="pl-vo">handler</span> <span class="pl-k">:=</span> rest.<span class="pl-vo">ResourceHandler</span>{
        PreRoutingMiddlewares: []rest.<span class="pl-vo">Middleware</span>{
            &amp;rest.<span class="pl-vo">AuthBasicMiddleware</span>{
                Realm: <span class="pl-s1"><span class="pl-pds">"</span>test zone<span class="pl-pds">"</span></span>,
                Authenticator: <span class="pl-s3">func</span>(userId <span class="pl-st">string</span>, password <span class="pl-st">string</span>) <span class="pl-st">bool</span> {
                    <span class="pl-k">if</span> userId == <span class="pl-s1"><span class="pl-pds">"</span>admin<span class="pl-pds">"</span></span> &amp;&amp; password == <span class="pl-s1"><span class="pl-pds">"</span>admin<span class="pl-pds">"</span></span> {
                        <span class="pl-k">return</span> <span class="pl-c1">true</span>
                    }
                    <span class="pl-k">return</span> <span class="pl-c1">false</span>
                },
            },
        },
    }
    <span class="pl-vo">err</span> <span class="pl-k">:=</span> handler.<span class="pl-s3">SetRoutes</span>(
        &amp;rest.<span class="pl-vo">Route</span>{<span class="pl-s1"><span class="pl-pds">"</span>GET<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>/countries<span class="pl-pds">"</span></span>, GetAllCountries},
    )
    <span class="pl-k">if</span> err != <span class="pl-c1">nil</span> {
        log.<span class="pl-s3">Fatal</span>(err)
    }
    log.<span class="pl-s3">Fatal</span>(http.<span class="pl-s3">ListenAndServe</span>(<span class="pl-s1"><span class="pl-pds">"</span>:8080<span class="pl-pds">"</span></span>, &amp;handler))
}

<span class="pl-k">type</span> <span class="pl-v">Country</span> <span class="pl-st">struct</span> {
    <span class="pl-v">Code</span> <span class="pl-st">string</span>
    <span class="pl-v">Name</span> <span class="pl-st">string</span>
}

<span class="pl-k">func</span> <span class="pl-en">GetAllCountries</span>(<span class="pl-v">w</span> <span class="pl-v">rest</span>.<span class="pl-v">ResponseWriter</span>, <span class="pl-v">r</span> *<span class="pl-v">rest</span>.<span class="pl-v">Request</span>) {
    w.<span class="pl-s3">WriteJson</span>(
        []Country{
            Country{
                Code: <span class="pl-s1"><span class="pl-pds">"</span>FR<span class="pl-pds">"</span></span>,
                Name: <span class="pl-s1"><span class="pl-pds">"</span>France<span class="pl-pds">"</span></span>,
            },
            Country{
                Code: <span class="pl-s1"><span class="pl-pds">"</span>US<span class="pl-pds">"</span></span>,
                Name: <span class="pl-s1"><span class="pl-pds">"</span>United States<span class="pl-pds">"</span></span>,
            },
        },
    )
}
</pre></div>

<h4>
<a id="status" class="anchor" href="#status" aria-hidden="true"><span class="octicon octicon-link"></span></a>Status</h4>

<p>Demonstrate how to setup a <code>/.status</code> endpoint</p>

<p>Inspired by memcached "stats", this optional feature can be enabled to help monitoring the service.
This example shows how to enable the stats, and how to setup the <code>/.status</code> route.</p>

<p>The curl demo:</p>

<pre><code>curl -i http://127.0.0.1:8080/.status
curl -i http://127.0.0.1:8080/.status
...
</code></pre>

<p>Output example:</p>

<pre><code>{
  "Pid": 21732,
  "UpTime": "1m15.926272s",
  "UpTimeSec": 75.926272,
  "Time": "2013-03-04 08:00:27.152986 +0000 UTC",
  "TimeUnix": 1362384027,
  "StatusCodeCount": {
        "200": 53,
        "404": 11
  },
  "TotalCount": 64,
  "TotalResponseTime": "16.777ms",
  "TotalResponseTimeSec": 0.016777,
  "AverageResponseTime": "262.14us",
  "AverageResponseTimeSec": 0.00026214
}
</code></pre>

<p>Go code:</p>

<div class="highlight highlight-go"><pre><span class="pl-k">package</span> main

<span class="pl-k">import</span> (
    <span class="pl-s1"><span class="pl-pds">"</span>github.com/ant0ine/go-json-rest/rest<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>log<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>net/http<span class="pl-pds">"</span></span>
)

<span class="pl-k">func</span> <span class="pl-en">main</span>() {
    <span class="pl-vo">handler</span> <span class="pl-k">:=</span> rest.<span class="pl-vo">ResourceHandler</span>{
        EnableStatusService: <span class="pl-c1">true</span>,
    }
    <span class="pl-vo">err</span> <span class="pl-k">:=</span> handler.<span class="pl-s3">SetRoutes</span>(
        &amp;rest.<span class="pl-vo">Route</span>{<span class="pl-s1"><span class="pl-pds">"</span>GET<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>/.status<span class="pl-pds">"</span></span>,
            <span class="pl-s3">func</span>(w rest.<span class="pl-vo">ResponseWriter</span>, r *rest.<span class="pl-vo">Request</span>) {
                w.<span class="pl-s3">WriteJson</span>(handler.<span class="pl-s3">GetStatus</span>())
            },
        },
    )
    <span class="pl-k">if</span> err != <span class="pl-c1">nil</span> {
        log.<span class="pl-s3">Fatal</span>(err)
    }
    log.<span class="pl-s3">Fatal</span>(http.<span class="pl-s3">ListenAndServe</span>(<span class="pl-s1"><span class="pl-pds">"</span>:8080<span class="pl-pds">"</span></span>, &amp;handler))
}
</pre></div>

<h4>
<a id="status-auth" class="anchor" href="#status-auth" aria-hidden="true"><span class="octicon octicon-link"></span></a>Status Auth</h4>

<p>Demonstrate how to setup a /.status endpoint protected with basic authentication.</p>

<p>This is a good use case of middleware applied to only one API endpoint.</p>

<p>The Curl Demo:</p>

<pre><code>curl -i http://127.0.0.1:8080/countries
curl -i http://127.0.0.1:8080/.status
curl -i -u admin:admin http://127.0.0.1:8080/.status
...
</code></pre>

<p>Go code:</p>

<div class="highlight highlight-go"><pre><span class="pl-k">package</span> main

<span class="pl-k">import</span> (
    <span class="pl-s1"><span class="pl-pds">"</span>github.com/ant0ine/go-json-rest/rest<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>log<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>net/http<span class="pl-pds">"</span></span>
)

<span class="pl-k">func</span> <span class="pl-en">main</span>() {
    <span class="pl-vo">handler</span> <span class="pl-k">:=</span> rest.<span class="pl-vo">ResourceHandler</span>{
        EnableStatusService: <span class="pl-c1">true</span>,
    }
    <span class="pl-vo">auth</span> <span class="pl-k">:=</span> &amp;rest.<span class="pl-vo">AuthBasicMiddleware</span>{
        Realm: <span class="pl-s1"><span class="pl-pds">"</span>test zone<span class="pl-pds">"</span></span>,
        Authenticator: <span class="pl-s3">func</span>(userId <span class="pl-st">string</span>, password <span class="pl-st">string</span>) <span class="pl-st">bool</span> {
            <span class="pl-k">if</span> userId == <span class="pl-s1"><span class="pl-pds">"</span>admin<span class="pl-pds">"</span></span> &amp;&amp; password == <span class="pl-s1"><span class="pl-pds">"</span>admin<span class="pl-pds">"</span></span> {
                <span class="pl-k">return</span> <span class="pl-c1">true</span>
            }
            <span class="pl-k">return</span> <span class="pl-c1">false</span>
        },
    }
    <span class="pl-vo">err</span> <span class="pl-k">:=</span> handler.<span class="pl-s3">SetRoutes</span>(
        &amp;rest.<span class="pl-vo">Route</span>{<span class="pl-s1"><span class="pl-pds">"</span>GET<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>/countries<span class="pl-pds">"</span></span>, GetAllCountries},
        &amp;rest.<span class="pl-vo">Route</span>{<span class="pl-s1"><span class="pl-pds">"</span>GET<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>/.status<span class="pl-pds">"</span></span>,
            auth.<span class="pl-s3">MiddlewareFunc</span>(
                <span class="pl-s3">func</span>(w rest.<span class="pl-vo">ResponseWriter</span>, r *rest.<span class="pl-vo">Request</span>) {
                    w.<span class="pl-s3">WriteJson</span>(handler.<span class="pl-s3">GetStatus</span>())
                },
            ),
        },
    )
    <span class="pl-k">if</span> err != <span class="pl-c1">nil</span> {
        log.<span class="pl-s3">Fatal</span>(err)
    }
    log.<span class="pl-s3">Fatal</span>(http.<span class="pl-s3">ListenAndServe</span>(<span class="pl-s1"><span class="pl-pds">"</span>:8080<span class="pl-pds">"</span></span>, &amp;handler))
}

<span class="pl-k">type</span> <span class="pl-v">Country</span> <span class="pl-st">struct</span> {
    <span class="pl-v">Code</span> <span class="pl-st">string</span>
    <span class="pl-v">Name</span> <span class="pl-st">string</span>
}

<span class="pl-k">func</span> <span class="pl-en">GetAllCountries</span>(<span class="pl-v">w</span> <span class="pl-v">rest</span>.<span class="pl-v">ResponseWriter</span>, <span class="pl-v">r</span> *<span class="pl-v">rest</span>.<span class="pl-v">Request</span>) {
    w.<span class="pl-s3">WriteJson</span>(
        []Country{
            Country{
                Code: <span class="pl-s1"><span class="pl-pds">"</span>FR<span class="pl-pds">"</span></span>,
                Name: <span class="pl-s1"><span class="pl-pds">"</span>France<span class="pl-pds">"</span></span>,
            },
            Country{
                Code: <span class="pl-s1"><span class="pl-pds">"</span>US<span class="pl-pds">"</span></span>,
                Name: <span class="pl-s1"><span class="pl-pds">"</span>United States<span class="pl-pds">"</span></span>,
            },
        },
    )
}
</pre></div>

<h3>
<a id="advanced" class="anchor" href="#advanced" aria-hidden="true"><span class="octicon octicon-link"></span></a>Advanced</h3>

<p>Less common use cases.</p>

<h4>
<a id="streaming" class="anchor" href="#streaming" aria-hidden="true"><span class="octicon octicon-link"></span></a>Streaming</h4>

<p>Demonstrate a streaming REST API, where the data is "flushed" to the client ASAP.</p>

<p>The stream format is a Line Delimited JSON.</p>

<p>The curl demo:</p>

<pre><code>curl -i http://127.0.0.1:8080/stream
</code></pre>

<p>Output:</p>

<pre><code>HTTP/1.1 200 OK
Content-Type: application/json
Date: Sun, 16 Feb 2014 00:39:19 GMT
Transfer-Encoding: chunked

{"Name":"thing #1"}
{"Name":"thing #2"}
{"Name":"thing #3"}
</code></pre>

<p>Go code:</p>

<div class="highlight highlight-go"><pre><span class="pl-k">package</span> main

<span class="pl-k">import</span> (
    <span class="pl-s1"><span class="pl-pds">"</span>fmt<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>github.com/ant0ine/go-json-rest/rest<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>log<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>net/http<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>time<span class="pl-pds">"</span></span>
)

<span class="pl-k">func</span> <span class="pl-en">main</span>() {

    <span class="pl-vo">handler</span> <span class="pl-k">:=</span> rest.<span class="pl-vo">ResourceHandler</span>{
        EnableRelaxedContentType: <span class="pl-c1">true</span>,
        DisableJsonIndent:        <span class="pl-c1">true</span>,
    }
    <span class="pl-vo">err</span> <span class="pl-k">:=</span> handler.<span class="pl-s3">SetRoutes</span>(
        &amp;rest.<span class="pl-vo">Route</span>{<span class="pl-s1"><span class="pl-pds">"</span>GET<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>/stream<span class="pl-pds">"</span></span>, StreamThings},
    )
    <span class="pl-k">if</span> err != <span class="pl-c1">nil</span> {
        log.<span class="pl-s3">Fatal</span>(err)
    }
    log.<span class="pl-s3">Fatal</span>(http.<span class="pl-s3">ListenAndServe</span>(<span class="pl-s1"><span class="pl-pds">"</span>:8080<span class="pl-pds">"</span></span>, &amp;handler))
}

<span class="pl-k">type</span> <span class="pl-v">Thing</span> <span class="pl-st">struct</span> {
    <span class="pl-v">Name</span> <span class="pl-st">string</span>
}

<span class="pl-k">func</span> <span class="pl-en">StreamThings</span>(<span class="pl-v">w</span> <span class="pl-v">rest</span>.<span class="pl-v">ResponseWriter</span>, <span class="pl-v">r</span> *<span class="pl-v">rest</span>.<span class="pl-v">Request</span>) {
    <span class="pl-vo">cpt</span> <span class="pl-k">:=</span> <span class="pl-c1">0</span>
    <span class="pl-k">for</span> {
        cpt++
        w.<span class="pl-s3">WriteJson</span>(
            &amp;Thing{
                Name: fmt.<span class="pl-s3">Sprintf</span>(<span class="pl-s1"><span class="pl-pds">"</span>thing #<span class="pl-c1">%d</span><span class="pl-pds">"</span></span>, cpt),
            },
        )
        w.(http.<span class="pl-vo">ResponseWriter</span>).<span class="pl-s3">Write</span>([]<span class="pl-st">byte</span>(<span class="pl-s1"><span class="pl-pds">"</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>))
        <span class="pl-c">// Flush the buffer to client</span>
        w.(http.<span class="pl-vo">Flusher</span>).<span class="pl-s3">Flush</span>()
        <span class="pl-c">// wait 3 seconds</span>
        time.<span class="pl-s3">Sleep</span>(time.<span class="pl-s3">Duration</span>(<span class="pl-c1">3</span>) * time.<span class="pl-vo">Second</span>)
    }
}
</pre></div>

<h4>
<a id="non-json-payload" class="anchor" href="#non-json-payload" aria-hidden="true"><span class="octicon octicon-link"></span></a>Non JSON payload</h4>

<p>Exceptional use of non JSON payloads.</p>

<p>The ResponseWriter implementation provided by go-json-rest is designed
to build JSON responses. In order to serve different kind of content,
it is recommended to either:
a) use another server and configure CORS
   (see the cors/ example)
b) combine the rest.ResourceHandler with another http.Handler
   (see api-and-static/ example)</p>

<p>That been said, exceptionally, it can be convenient to return a
different content type on a JSON endpoint. In this case, setting the
Content-Type and using the type assertion to access the Write method
is enough. As shown in this example.</p>

<p>The curl demo:</p>

<pre><code>curl -i http://127.0.0.1:8080/message.txt
</code></pre>

<p>Go code:</p>

<div class="highlight highlight-go"><pre><span class="pl-k">package</span> main

<span class="pl-k">import</span> (
    <span class="pl-s1"><span class="pl-pds">"</span>github.com/ant0ine/go-json-rest/rest<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>log<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>net/http<span class="pl-pds">"</span></span>
)

<span class="pl-k">func</span> <span class="pl-en">main</span>() {
    <span class="pl-vo">handler</span> <span class="pl-k">:=</span> rest.<span class="pl-vo">ResourceHandler</span>{}
    <span class="pl-vo">err</span> <span class="pl-k">:=</span> handler.<span class="pl-s3">SetRoutes</span>(
        &amp;rest.<span class="pl-vo">Route</span>{<span class="pl-s1"><span class="pl-pds">"</span>GET<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>/message.txt<span class="pl-pds">"</span></span>, <span class="pl-s3">func</span>(w rest.<span class="pl-vo">ResponseWriter</span>, req *rest.<span class="pl-vo">Request</span>) {
            w.<span class="pl-s3">Header</span>().<span class="pl-s3">Set</span>(<span class="pl-s1"><span class="pl-pds">"</span>Content-Type<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>text/plain<span class="pl-pds">"</span></span>)
            w.(http.<span class="pl-vo">ResponseWriter</span>).<span class="pl-s3">Write</span>([]<span class="pl-st">byte</span>(<span class="pl-s1"><span class="pl-pds">"</span>Hello World!<span class="pl-pds">"</span></span>))
        }},
    )
    <span class="pl-k">if</span> err != <span class="pl-c1">nil</span> {
        log.<span class="pl-s3">Fatal</span>(err)
    }
    log.<span class="pl-s3">Fatal</span>(http.<span class="pl-s3">ListenAndServe</span>(<span class="pl-s1"><span class="pl-pds">"</span>:8080<span class="pl-pds">"</span></span>, &amp;handler))
}
</pre></div>

<h4>
<a id="api-versioning" class="anchor" href="#api-versioning" aria-hidden="true"><span class="octicon octicon-link"></span></a>API Versioning</h4>

<p>First, API versioning is not easy and you may want to favor a mechanism that uses only backward compatible changes and deprecation cycles.</p>

<p>That been said, here is an example of API versioning using <a href="http://semver.org/">Semver</a></p>

<p>It defines a middleware that parses the version, checks a min and a max, and makes it available in the <code>request.Env</code>.</p>

<p>(TODO, there is an obvious need for PostRoutingMiddlewares here.)</p>

<p>The curl demo:</p>

<div class="highlight highlight-sh"><pre>curl -i http://127.0.0.1:8080/api/1.0.0/message
curl -i http://127.0.0.1:8080/api/2.0.0/message
curl -i http://127.0.0.1:8080/api/2.0.1/message
curl -i http://127.0.0.1:8080/api/0.0.1/message
curl -i http://127.0.0.1:8080/api/4.0.1/message
</pre></div>

<p>Go code:</p>

<div class="highlight highlight-go"><pre><span class="pl-k">package</span> main

<span class="pl-k">import</span> (
    <span class="pl-s1"><span class="pl-pds">"</span>github.com/ant0ine/go-json-rest/rest<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>github.com/coreos/go-semver/semver<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>log<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>net/http<span class="pl-pds">"</span></span>
)

<span class="pl-k">type</span> <span class="pl-v">SemVerMiddleware</span> <span class="pl-st">struct</span> {
    <span class="pl-v">MinVersion</span> <span class="pl-st">string</span>
    <span class="pl-v">MaxVersion</span> <span class="pl-st">string</span>
}

<span class="pl-k">func</span> <span class="pl-en">(<span class="pl-v">mw</span> *<span class="pl-v">SemVerMiddleware</span>) <span class="pl-en">MiddlewareFunc</span></span>(<span class="pl-v">handler</span> <span class="pl-v">rest</span>.<span class="pl-v">HandlerFunc</span>) <span class="pl-v">rest</span>.<span class="pl-v">HandlerFunc</span> {

    <span class="pl-vo">minVersion</span>, <span class="pl-vo">err</span> <span class="pl-k">:=</span> semver.<span class="pl-s3">NewVersion</span>(mw.<span class="pl-vo">MinVersion</span>)
    <span class="pl-k">if</span> err != <span class="pl-c1">nil</span> {
        <span class="pl-s3">panic</span>(err)
    }

    <span class="pl-vo">maxVersion</span>, <span class="pl-vo">err</span> <span class="pl-k">:=</span> semver.<span class="pl-s3">NewVersion</span>(mw.<span class="pl-vo">MaxVersion</span>)
    <span class="pl-k">if</span> err != <span class="pl-c1">nil</span> {
        <span class="pl-s3">panic</span>(err)
    }

    <span class="pl-k">return</span> <span class="pl-s3">func</span>(writer rest.<span class="pl-vo">ResponseWriter</span>, request *rest.<span class="pl-vo">Request</span>) {

        <span class="pl-vo">version</span>, <span class="pl-vo">err</span> <span class="pl-k">:=</span> semver.<span class="pl-s3">NewVersion</span>(request.<span class="pl-s3">PathParam</span>(<span class="pl-s1"><span class="pl-pds">"</span>version<span class="pl-pds">"</span></span>))
        <span class="pl-k">if</span> err != <span class="pl-c1">nil</span> {
            rest.<span class="pl-s3">Error</span>(writer, <span class="pl-s1"><span class="pl-pds">"</span>Invalid version: <span class="pl-pds">"</span></span>+err.<span class="pl-s3">Error</span>(), http.<span class="pl-vo">StatusBadRequest</span>)
            <span class="pl-k">return</span>
        }

        <span class="pl-k">if</span> version.<span class="pl-s3">LessThan</span>(*minVersion) {
            rest.<span class="pl-s3">Error</span>(writer, <span class="pl-s1"><span class="pl-pds">"</span>Min supported version is <span class="pl-pds">"</span></span>+minVersion.<span class="pl-s3">String</span>(), http.<span class="pl-vo">StatusBadRequest</span>)
            <span class="pl-k">return</span>
        }

        <span class="pl-k">if</span> maxVersion.<span class="pl-s3">LessThan</span>(*version) {
            rest.<span class="pl-s3">Error</span>(writer, <span class="pl-s1"><span class="pl-pds">"</span>Max supported version is <span class="pl-pds">"</span></span>+maxVersion.<span class="pl-s3">String</span>(), http.<span class="pl-vo">StatusBadRequest</span>)
            <span class="pl-k">return</span>
        }

        request.<span class="pl-vo">Env</span>[<span class="pl-s1"><span class="pl-pds">"</span>VERSION<span class="pl-pds">"</span></span>] = version
        <span class="pl-s3">handler</span>(writer, request)
    }
}

<span class="pl-k">func</span> <span class="pl-en">main</span>() {
    <span class="pl-vo">handler</span> <span class="pl-k">:=</span> rest.<span class="pl-vo">ResourceHandler</span>{}
    <span class="pl-vo">svmw</span> <span class="pl-k">:=</span> SemVerMiddleware{
        MinVersion: <span class="pl-s1"><span class="pl-pds">"</span>1.0.0<span class="pl-pds">"</span></span>,
        MaxVersion: <span class="pl-s1"><span class="pl-pds">"</span>3.0.0<span class="pl-pds">"</span></span>,
    }
    <span class="pl-vo">err</span> <span class="pl-k">:=</span> handler.<span class="pl-s3">SetRoutes</span>(
        &amp;rest.<span class="pl-vo">Route</span>{<span class="pl-s1"><span class="pl-pds">"</span>GET<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>/#version/message<span class="pl-pds">"</span></span>, svmw.<span class="pl-s3">MiddlewareFunc</span>(
            <span class="pl-s3">func</span>(w rest.<span class="pl-vo">ResponseWriter</span>, req *rest.<span class="pl-vo">Request</span>) {
                <span class="pl-vo">version</span> <span class="pl-k">:=</span> req.<span class="pl-vo">Env</span>[<span class="pl-s1"><span class="pl-pds">"</span>VERSION<span class="pl-pds">"</span></span>].(*semver.<span class="pl-vo">Version</span>)
                <span class="pl-k">if</span> version.<span class="pl-vo">Major</span> == <span class="pl-c1">2</span> {
                    <span class="pl-c">// http://en.wikipedia.org/wiki/Second-system_effect</span>
                    w.<span class="pl-s3">WriteJson</span>(<span class="pl-s">map</span>[<span class="pl-st">string</span>]<span class="pl-st">string</span>{<span class="pl-s1"><span class="pl-pds">"</span>Body<span class="pl-pds">"</span></span>: <span class="pl-s1"><span class="pl-pds">"</span>Hello broken World!<span class="pl-pds">"</span></span>})
                } <span class="pl-k">else</span> {
                    w.<span class="pl-s3">WriteJson</span>(<span class="pl-s">map</span>[<span class="pl-st">string</span>]<span class="pl-st">string</span>{<span class="pl-s1"><span class="pl-pds">"</span>Body<span class="pl-pds">"</span></span>: <span class="pl-s1"><span class="pl-pds">"</span>Hello World!<span class="pl-pds">"</span></span>})
                }
            },
        )},
    )
    <span class="pl-k">if</span> err != <span class="pl-c1">nil</span> {
        log.<span class="pl-s3">Fatal</span>(err)
    }
    http.<span class="pl-s3">Handle</span>(<span class="pl-s1"><span class="pl-pds">"</span>/api/<span class="pl-pds">"</span></span>, http.<span class="pl-s3">StripPrefix</span>(<span class="pl-s1"><span class="pl-pds">"</span>/api<span class="pl-pds">"</span></span>, &amp;handler))
    log.<span class="pl-s3">Fatal</span>(http.<span class="pl-s3">ListenAndServe</span>(<span class="pl-s1"><span class="pl-pds">"</span>:8080<span class="pl-pds">"</span></span>, <span class="pl-c1">nil</span>))
}
</pre></div>

<h4>
<a id="statsd" class="anchor" href="#statsd" aria-hidden="true"><span class="octicon octicon-link"></span></a>Statsd</h4>

<p>Demonstrate how to use OuterMiddlewares to do additional logging and reporting.</p>

<p>Here <code>request.Env["STATUS_CODE"]</code> and <code>request.Env["ELAPSED_TIME"]</code> that are available to outer middlewares are used with the <a href="https://github.com/peterbourgon/g2s">g2s</a> statsd client to send these metrics to statsd.</p>

<p>The curl demo:</p>

<div class="highlight highlight-sh"><pre><span class="pl-c"># start statsd server</span>
<span class="pl-c"># monitor network</span>
ngrep -d any port 8125

curl -i http://127.0.0.1:8080/message
curl -i http://127.0.0.1:8080/doesnotexist
</pre></div>

<p>Go code:</p>

<div class="highlight highlight-go"><pre><span class="pl-k">package</span> main

<span class="pl-k">import</span> (
    <span class="pl-s1"><span class="pl-pds">"</span>github.com/ant0ine/go-json-rest/rest<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>github.com/peterbourgon/g2s<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>log<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>net/http<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>strconv<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>time<span class="pl-pds">"</span></span>
)

<span class="pl-k">type</span> <span class="pl-v">StatsdMiddleware</span> <span class="pl-st">struct</span> {
    <span class="pl-v">IpPort</span> <span class="pl-st">string</span>
    <span class="pl-v">Prefix</span> <span class="pl-st">string</span>
}

<span class="pl-k">func</span> <span class="pl-en">(<span class="pl-v">mw</span> *<span class="pl-v">StatsdMiddleware</span>) <span class="pl-en">MiddlewareFunc</span></span>(<span class="pl-v">handler</span> <span class="pl-v">rest</span>.<span class="pl-v">HandlerFunc</span>) <span class="pl-v">rest</span>.<span class="pl-v">HandlerFunc</span> {

    <span class="pl-vo">statsd</span>, <span class="pl-vo">err</span> <span class="pl-k">:=</span> g2s.<span class="pl-s3">Dial</span>(<span class="pl-s1"><span class="pl-pds">"</span>udp<span class="pl-pds">"</span></span>, mw.<span class="pl-vo">IpPort</span>)
    <span class="pl-k">if</span> err != <span class="pl-c1">nil</span> {
        <span class="pl-s3">panic</span>(err)
    }

    <span class="pl-vo">keyBase</span> <span class="pl-k">:=</span> <span class="pl-s1"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>
    <span class="pl-k">if</span> mw.<span class="pl-vo">Prefix</span> != <span class="pl-s1"><span class="pl-pds">"</span><span class="pl-pds">"</span></span> {
        keyBase += mw.<span class="pl-vo">Prefix</span> + <span class="pl-s1"><span class="pl-pds">"</span>.<span class="pl-pds">"</span></span>
    }
    keyBase += <span class="pl-s1"><span class="pl-pds">"</span>response.<span class="pl-pds">"</span></span>

    <span class="pl-k">return</span> <span class="pl-s3">func</span>(writer rest.<span class="pl-vo">ResponseWriter</span>, request *rest.<span class="pl-vo">Request</span>) {

        <span class="pl-s3">handler</span>(writer, request)

        <span class="pl-vo">statusCode</span> <span class="pl-k">:=</span> request.<span class="pl-vo">Env</span>[<span class="pl-s1"><span class="pl-pds">"</span>STATUS_CODE<span class="pl-pds">"</span></span>].(<span class="pl-st">int</span>)
        statsd.<span class="pl-s3">Counter</span>(<span class="pl-c1">1.0</span>, keyBase+<span class="pl-s1"><span class="pl-pds">"</span>status_code.<span class="pl-pds">"</span></span>+strconv.<span class="pl-s3">Itoa</span>(statusCode), <span class="pl-c1">1</span>)

        <span class="pl-vo">elapsedTime</span> <span class="pl-k">:=</span> request.<span class="pl-vo">Env</span>[<span class="pl-s1"><span class="pl-pds">"</span>ELAPSED_TIME<span class="pl-pds">"</span></span>].(*time.<span class="pl-vo">Duration</span>)
        statsd.<span class="pl-s3">Timing</span>(<span class="pl-c1">1.0</span>, keyBase+<span class="pl-s1"><span class="pl-pds">"</span>elapsed_time<span class="pl-pds">"</span></span>, *elapsedTime)
    }
}

<span class="pl-k">func</span> <span class="pl-en">main</span>() {
    <span class="pl-vo">handler</span> <span class="pl-k">:=</span> rest.<span class="pl-vo">ResourceHandler</span>{
        OuterMiddlewares: []rest.<span class="pl-vo">Middleware</span>{
            &amp;StatsdMiddleware{
                IpPort: <span class="pl-s1"><span class="pl-pds">"</span>localhost:8125<span class="pl-pds">"</span></span>,
            },
        },
    }
    <span class="pl-vo">err</span> <span class="pl-k">:=</span> handler.<span class="pl-s3">SetRoutes</span>(
        &amp;rest.<span class="pl-vo">Route</span>{<span class="pl-s1"><span class="pl-pds">"</span>GET<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>/message<span class="pl-pds">"</span></span>, <span class="pl-s3">func</span>(w rest.<span class="pl-vo">ResponseWriter</span>, req *rest.<span class="pl-vo">Request</span>) {

            <span class="pl-c">// take more than 1ms so statsd can report it</span>
            time.<span class="pl-s3">Sleep</span>(<span class="pl-c1">100</span> * time.<span class="pl-vo">Millisecond</span>)

            w.<span class="pl-s3">WriteJson</span>(<span class="pl-s">map</span>[<span class="pl-st">string</span>]<span class="pl-st">string</span>{<span class="pl-s1"><span class="pl-pds">"</span>Body<span class="pl-pds">"</span></span>: <span class="pl-s1"><span class="pl-pds">"</span>Hello World!<span class="pl-pds">"</span></span>})
        }},
    )
    <span class="pl-k">if</span> err != <span class="pl-c1">nil</span> {
        log.<span class="pl-s3">Fatal</span>(err)
    }
    log.<span class="pl-s3">Fatal</span>(http.<span class="pl-s3">ListenAndServe</span>(<span class="pl-s1"><span class="pl-pds">"</span>:8080<span class="pl-pds">"</span></span>, &amp;handler))
}
</pre></div>

<h4>
<a id="newrelic" class="anchor" href="#newrelic" aria-hidden="true"><span class="octicon octicon-link"></span></a>NewRelic</h4>

<p>NewRelic integration based on the GoRelic plugin: <a href="http://github.com/yvasiyarov/gorelic">github.com/yvasiyarov/gorelic</a></p>

<p>The curl demo:</p>

<div class="highlight highlight-sh"><pre>curl -i http://127.0.0.1:8080/message</pre></div>

<p>Go code:</p>

<div class="highlight highlight-go"><pre><span class="pl-k">package</span> main

<span class="pl-k">import</span> (
    <span class="pl-s1"><span class="pl-pds">"</span>github.com/ant0ine/go-json-rest/rest<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>github.com/yvasiyarov/go-metrics<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>github.com/yvasiyarov/gorelic<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>log<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>net/http<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>time<span class="pl-pds">"</span></span>
)

<span class="pl-k">type</span> <span class="pl-v">NewRelicMiddleware</span> <span class="pl-st">struct</span> {
    <span class="pl-v">License</span> <span class="pl-st">string</span>
    <span class="pl-v">Name</span>    <span class="pl-st">string</span>
    <span class="pl-v">Verbose</span> <span class="pl-st">bool</span>
    agent   *gorelic.<span class="pl-vo">Agent</span>
}

<span class="pl-k">func</span> <span class="pl-en">(<span class="pl-v">mw</span> *<span class="pl-v">NewRelicMiddleware</span>) <span class="pl-en">MiddlewareFunc</span></span>(<span class="pl-v">handler</span> <span class="pl-v">rest</span>.<span class="pl-v">HandlerFunc</span>) <span class="pl-v">rest</span>.<span class="pl-v">HandlerFunc</span> {

    mw.<span class="pl-vo">agent</span> = gorelic.<span class="pl-s3">NewAgent</span>()
    mw.<span class="pl-vo">agent</span>.<span class="pl-vo">NewrelicLicense</span> = mw.<span class="pl-vo">License</span>
    mw.<span class="pl-vo">agent</span>.<span class="pl-vo">HTTPTimer</span> = metrics.<span class="pl-s3">NewTimer</span>()
    mw.<span class="pl-vo">agent</span>.<span class="pl-vo">Verbose</span> = mw.<span class="pl-vo">Verbose</span>
    mw.<span class="pl-vo">agent</span>.<span class="pl-vo">NewrelicName</span> = mw.<span class="pl-vo">Name</span>
    mw.<span class="pl-vo">agent</span>.<span class="pl-vo">CollectHTTPStat</span> = <span class="pl-c1">true</span>
    mw.<span class="pl-vo">agent</span>.<span class="pl-s3">Run</span>()

    <span class="pl-k">return</span> <span class="pl-s3">func</span>(writer rest.<span class="pl-vo">ResponseWriter</span>, request *rest.<span class="pl-vo">Request</span>) {

        <span class="pl-s3">handler</span>(writer, request)

        <span class="pl-c">// the timer middleware keeps track of the time</span>
        <span class="pl-vo">startTime</span> <span class="pl-k">:=</span> request.<span class="pl-vo">Env</span>[<span class="pl-s1"><span class="pl-pds">"</span>START_TIME<span class="pl-pds">"</span></span>].(*time.<span class="pl-vo">Time</span>)
        mw.<span class="pl-vo">agent</span>.<span class="pl-vo">HTTPTimer</span>.<span class="pl-s3">UpdateSince</span>(*startTime)
    }
}

<span class="pl-k">func</span> <span class="pl-en">main</span>() {
    <span class="pl-vo">handler</span> <span class="pl-k">:=</span> rest.<span class="pl-vo">ResourceHandler</span>{
        OuterMiddlewares: []rest.<span class="pl-vo">Middleware</span>{
            &amp;NewRelicMiddleware{
                License: <span class="pl-s1"><span class="pl-pds">"</span>&lt;REPLACE WITH THE LICENSE KEY&gt;<span class="pl-pds">"</span></span>,
                Name:    <span class="pl-s1"><span class="pl-pds">"</span>&lt;REPLACE WITH THE APP NAME&gt;<span class="pl-pds">"</span></span>,
                Verbose: <span class="pl-c1">true</span>,
            },
        },
    }
    <span class="pl-vo">err</span> <span class="pl-k">:=</span> handler.<span class="pl-s3">SetRoutes</span>(
        &amp;rest.<span class="pl-vo">Route</span>{<span class="pl-s1"><span class="pl-pds">"</span>GET<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>/message<span class="pl-pds">"</span></span>, <span class="pl-s3">func</span>(w rest.<span class="pl-vo">ResponseWriter</span>, req *rest.<span class="pl-vo">Request</span>) {
            w.<span class="pl-s3">WriteJson</span>(<span class="pl-s">map</span>[<span class="pl-st">string</span>]<span class="pl-st">string</span>{<span class="pl-s1"><span class="pl-pds">"</span>Body<span class="pl-pds">"</span></span>: <span class="pl-s1"><span class="pl-pds">"</span>Hello World!<span class="pl-pds">"</span></span>})
        }},
    )
    <span class="pl-k">if</span> err != <span class="pl-c1">nil</span> {
        log.<span class="pl-s3">Fatal</span>(err)
    }
    log.<span class="pl-s3">Fatal</span>(http.<span class="pl-s3">ListenAndServe</span>(<span class="pl-s1"><span class="pl-pds">"</span>:8080<span class="pl-pds">"</span></span>, &amp;handler))
}
</pre></div>

<h4>
<a id="graceful-shutdown" class="anchor" href="#graceful-shutdown" aria-hidden="true"><span class="octicon octicon-link"></span></a>Graceful Shutdown</h4>

<p>This example uses <a href="https://github.com/stretchr/graceful">github.com/stretchr/graceful</a> to try to be nice with the clients waiting for responses during a server shutdown (or restart).
The HTTP response takes 10 seconds to be completed, printing a message on the wire every second.
10 seconds is also the timeout set for the graceful shutdown.
You can play with these numbers to show that the server waits for the responses to complete.</p>

<p>The curl demo:</p>

<div class="highlight highlight-sh"><pre>curl -i http://127.0.0.1:8080/message</pre></div>

<p>Go code:</p>

<div class="highlight highlight-go"><pre><span class="pl-k">package</span> main

<span class="pl-k">import</span> (
    <span class="pl-s1"><span class="pl-pds">"</span>fmt<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>github.com/ant0ine/go-json-rest/rest<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>github.com/stretchr/graceful<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>log<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>net/http<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>time<span class="pl-pds">"</span></span>
)

<span class="pl-k">func</span> <span class="pl-en">main</span>() {

    <span class="pl-vo">handler</span> <span class="pl-k">:=</span> rest.<span class="pl-vo">ResourceHandler</span>{}

    <span class="pl-vo">err</span> <span class="pl-k">:=</span> handler.<span class="pl-s3">SetRoutes</span>(
        &amp;rest.<span class="pl-vo">Route</span>{<span class="pl-s1"><span class="pl-pds">"</span>GET<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>/message<span class="pl-pds">"</span></span>, <span class="pl-s3">func</span>(w rest.<span class="pl-vo">ResponseWriter</span>, req *rest.<span class="pl-vo">Request</span>) {
            <span class="pl-k">for</span> <span class="pl-vo">cpt</span> <span class="pl-k">:=</span> <span class="pl-c1">1</span>; cpt &lt;= <span class="pl-c1">10</span>; cpt++ {

                <span class="pl-c">// wait 1 second</span>
                time.<span class="pl-s3">Sleep</span>(time.<span class="pl-s3">Duration</span>(<span class="pl-c1">1</span>) * time.<span class="pl-vo">Second</span>)

                w.<span class="pl-s3">WriteJson</span>(<span class="pl-s">map</span>[<span class="pl-st">string</span>]<span class="pl-st">string</span>{<span class="pl-s1"><span class="pl-pds">"</span>Message<span class="pl-pds">"</span></span>: fmt.<span class="pl-s3">Sprintf</span>(<span class="pl-s1"><span class="pl-pds">"</span><span class="pl-c1">%d</span> seconds<span class="pl-pds">"</span></span>, cpt)})
                w.(http.<span class="pl-vo">ResponseWriter</span>).<span class="pl-s3">Write</span>([]<span class="pl-st">byte</span>(<span class="pl-s1"><span class="pl-pds">"</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>))

                <span class="pl-c">// Flush the buffer to client</span>
                w.(http.<span class="pl-vo">Flusher</span>).<span class="pl-s3">Flush</span>()
            }
        }},
    )
    <span class="pl-k">if</span> err != <span class="pl-c1">nil</span> {
        log.<span class="pl-s3">Fatal</span>(err)
    }

    <span class="pl-vo">server</span> <span class="pl-k">:=</span> &amp;graceful.<span class="pl-vo">Server</span>{
        Timeout: <span class="pl-c1">10</span> * time.<span class="pl-vo">Second</span>,
        Server: &amp;http.<span class="pl-vo">Server</span>{
            Addr:    <span class="pl-s1"><span class="pl-pds">"</span>:8080<span class="pl-pds">"</span></span>,
            Handler: &amp;handler,
        },
    }

    log.<span class="pl-s3">Fatal</span>(server.<span class="pl-s3">ListenAndServe</span>())
}
</pre></div>

<h4>
<a id="spdy" class="anchor" href="#spdy" aria-hidden="true"><span class="octicon octicon-link"></span></a>SPDY</h4>

<p>Demonstrate how to use SPDY with <a href="https://github.com/shykes/spdy-go">https://github.com/shykes/spdy-go</a></p>

<p>For a command line client, install spdycat from:
<a href="https://github.com/tatsuhiro-t/spdylay">https://github.com/tatsuhiro-t/spdylay</a></p>

<p>The spdycat demo:</p>

<pre><code>spdycat -v --no-tls -2 http://localhost:8080/users/0
</code></pre>

<p>Go code:</p>

<div class="highlight highlight-go"><pre><span class="pl-k">package</span> main

<span class="pl-k">import</span> (
    <span class="pl-s1"><span class="pl-pds">"</span>github.com/ant0ine/go-json-rest/rest<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>github.com/shykes/spdy-go<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>log<span class="pl-pds">"</span></span>
)

<span class="pl-k">type</span> <span class="pl-v">User</span> <span class="pl-st">struct</span> {
    <span class="pl-v">Id</span>   <span class="pl-st">string</span>
    <span class="pl-v">Name</span> <span class="pl-st">string</span>
}

<span class="pl-k">func</span> <span class="pl-en">GetUser</span>(<span class="pl-v">w</span> <span class="pl-v">rest</span>.<span class="pl-v">ResponseWriter</span>, <span class="pl-v">req</span> *<span class="pl-v">rest</span>.<span class="pl-v">Request</span>) {
    <span class="pl-vo">user</span> <span class="pl-k">:=</span> User{
        Id:   req.<span class="pl-s3">PathParam</span>(<span class="pl-s1"><span class="pl-pds">"</span>id<span class="pl-pds">"</span></span>),
        Name: <span class="pl-s1"><span class="pl-pds">"</span>Antoine<span class="pl-pds">"</span></span>,
    }
    w.<span class="pl-s3">WriteJson</span>(&amp;user)
}

<span class="pl-k">func</span> <span class="pl-en">main</span>() {
    <span class="pl-vo">handler</span> <span class="pl-k">:=</span> rest.<span class="pl-vo">ResourceHandler</span>{}
    <span class="pl-vo">err</span> <span class="pl-k">:=</span> handler.<span class="pl-s3">SetRoutes</span>(
        &amp;rest.<span class="pl-vo">Route</span>{<span class="pl-s1"><span class="pl-pds">"</span>GET<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>/users/:id<span class="pl-pds">"</span></span>, GetUser},
    )
    <span class="pl-k">if</span> err != <span class="pl-c1">nil</span> {
        log.<span class="pl-s3">Fatal</span>(err)
    }
    log.<span class="pl-s3">Fatal</span>(spdy.<span class="pl-s3">ListenAndServeTCP</span>(<span class="pl-s1"><span class="pl-pds">"</span>:8080<span class="pl-pds">"</span></span>, &amp;handler))
}
</pre></div>

<h4>
<a id="gae" class="anchor" href="#gae" aria-hidden="true"><span class="octicon octicon-link"></span></a>GAE</h4>

<p>Demonstrate a simple Google App Engine app</p>

<p>Here are my steps to make it work with the GAE SDK.
(Probably not the best ones)</p>

<p>Assuming that go-json-rest is installed using "go get"
and that the GAE SDK is also installed.</p>

<p>Setup:</p>

<ul>
<li>copy this examples/gae/ dir outside of the go-json-rest/ tree</li>
<li>cd gae/</li>
<li>mkdir -p github.com/ant0ine</li>
<li>cp -r $GOPATH/src/github.com/ant0ine/go-json-rest github.com/ant0ine/go-json-rest</li>
<li>rm -rf github.com/ant0ine/go-json-rest/examples/</li>
<li>path/to/google_appengine/dev_appserver.py .</li>
</ul>

<p>The curl demo:</p>

<pre><code>curl -i http://127.0.0.1:8080/message
</code></pre>

<p>Go code:</p>

<div class="highlight highlight-go"><pre><span class="pl-k">package</span> gaehelloworld

<span class="pl-k">import</span> (
    <span class="pl-s1"><span class="pl-pds">"</span>github.com/ant0ine/go-json-rest/rest<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>log<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>net/http<span class="pl-pds">"</span></span>
)

<span class="pl-k">func</span> <span class="pl-en">init</span>() {
    <span class="pl-vo">handler</span> <span class="pl-k">:=</span> rest.<span class="pl-vo">ResourceHandler</span>{}
    <span class="pl-vo">err</span> <span class="pl-k">:=</span> handler.<span class="pl-s3">SetRoutes</span>(
        &amp;rest.<span class="pl-vo">Route</span>{<span class="pl-s1"><span class="pl-pds">"</span>GET<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>/message<span class="pl-pds">"</span></span>, <span class="pl-s3">func</span>(w rest.<span class="pl-vo">ResponseWriter</span>, req *rest.<span class="pl-vo">Request</span>) {
            w.<span class="pl-s3">WriteJson</span>(<span class="pl-s">map</span>[<span class="pl-st">string</span>]<span class="pl-st">string</span>{<span class="pl-s1"><span class="pl-pds">"</span>Body<span class="pl-pds">"</span></span>: <span class="pl-s1"><span class="pl-pds">"</span>Hello World!<span class="pl-pds">"</span></span>})
        }},
    )
    <span class="pl-k">if</span> err != <span class="pl-c1">nil</span> {
        log.<span class="pl-s3">Fatal</span>(err)
    }
    http.<span class="pl-s3">Handle</span>(<span class="pl-s1"><span class="pl-pds">"</span>/<span class="pl-pds">"</span></span>, &amp;handler)
}
</pre></div>

<h4>
<a id="basic-auth-custom" class="anchor" href="#basic-auth-custom" aria-hidden="true"><span class="octicon octicon-link"></span></a>Basic Auth Custom</h4>

<p>Demonstrate how to implement a custom AuthBasic middleware, used to protect all endpoints.</p>

<p>This is a very simple version supporting only one user.</p>

<p>The curl demo:</p>

<pre><code>curl -i http://127.0.0.1:8080/countries
</code></pre>

<p>Go code:</p>

<div class="highlight highlight-go"><pre><span class="pl-k">package</span> main

<span class="pl-k">import</span> (
    <span class="pl-s1"><span class="pl-pds">"</span>encoding/base64<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>errors<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>github.com/ant0ine/go-json-rest/rest<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>log<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>net/http<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>strings<span class="pl-pds">"</span></span>
)

<span class="pl-k">type</span> <span class="pl-v">MyAuthBasicMiddleware</span> <span class="pl-st">struct</span> {
    <span class="pl-v">Realm</span>    <span class="pl-st">string</span>
    <span class="pl-v">UserId</span>   <span class="pl-st">string</span>
    <span class="pl-v">Password</span> <span class="pl-st">string</span>
}

<span class="pl-k">func</span> <span class="pl-en">(<span class="pl-v">mw</span> *<span class="pl-v">MyAuthBasicMiddleware</span>) <span class="pl-en">MiddlewareFunc</span></span>(<span class="pl-v">handler</span> <span class="pl-v">rest</span>.<span class="pl-v">HandlerFunc</span>) <span class="pl-v">rest</span>.<span class="pl-v">HandlerFunc</span> {
    <span class="pl-k">return</span> <span class="pl-s3">func</span>(writer rest.<span class="pl-vo">ResponseWriter</span>, request *rest.<span class="pl-vo">Request</span>) {

        <span class="pl-vo">authHeader</span> <span class="pl-k">:=</span> request.<span class="pl-vo">Header</span>.<span class="pl-s3">Get</span>(<span class="pl-s1"><span class="pl-pds">"</span>Authorization<span class="pl-pds">"</span></span>)
        <span class="pl-k">if</span> authHeader == <span class="pl-s1"><span class="pl-pds">"</span><span class="pl-pds">"</span></span> {
            mw.<span class="pl-s3">unauthorized</span>(writer)
            <span class="pl-k">return</span>
        }

        <span class="pl-vo">providedUserId</span>, <span class="pl-vo">providedPassword</span>, <span class="pl-vo">err</span> <span class="pl-k">:=</span> mw.<span class="pl-s3">decodeBasicAuthHeader</span>(authHeader)

        <span class="pl-k">if</span> err != <span class="pl-c1">nil</span> {
            rest.<span class="pl-s3">Error</span>(writer, <span class="pl-s1"><span class="pl-pds">"</span>Invalid authentication<span class="pl-pds">"</span></span>, http.<span class="pl-vo">StatusBadRequest</span>)
            <span class="pl-k">return</span>
        }

        <span class="pl-k">if</span> !(providedUserId == mw.<span class="pl-vo">UserId</span> &amp;&amp; providedPassword == mw.<span class="pl-vo">Password</span>) {
            mw.<span class="pl-s3">unauthorized</span>(writer)
            <span class="pl-k">return</span>
        }

        <span class="pl-s3">handler</span>(writer, request)
    }
}

<span class="pl-k">func</span> <span class="pl-en">(<span class="pl-v">mw</span> *<span class="pl-v">MyAuthBasicMiddleware</span>) <span class="pl-en">unauthorized</span></span>(<span class="pl-v">writer</span> <span class="pl-v">rest</span>.<span class="pl-v">ResponseWriter</span>) {
    writer.<span class="pl-s3">Header</span>().<span class="pl-s3">Set</span>(<span class="pl-s1"><span class="pl-pds">"</span>WWW-Authenticate<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>Basic realm=<span class="pl-pds">"</span></span>+mw.<span class="pl-vo">Realm</span>)
    rest.<span class="pl-s3">Error</span>(writer, <span class="pl-s1"><span class="pl-pds">"</span>Not Authorized<span class="pl-pds">"</span></span>, http.<span class="pl-vo">StatusUnauthorized</span>)
}

<span class="pl-k">func</span> <span class="pl-en">(<span class="pl-v">mw</span> *<span class="pl-v">MyAuthBasicMiddleware</span>) <span class="pl-en">decodeBasicAuthHeader</span></span>(<span class="pl-v">header</span> <span class="pl-v">string</span>) (<span class="pl-v">user</span> <span class="pl-v">string</span>, <span class="pl-v">password</span> <span class="pl-v">string</span>, <span class="pl-v">err</span> <span class="pl-v">error</span>) {

    <span class="pl-vo">parts</span> <span class="pl-k">:=</span> strings.<span class="pl-s3">SplitN</span>(header, <span class="pl-s1"><span class="pl-pds">"</span> <span class="pl-pds">"</span></span>, <span class="pl-c1">2</span>)
    <span class="pl-k">if</span> !(<span class="pl-s3">len</span>(parts) == <span class="pl-c1">2</span> &amp;&amp; parts[<span class="pl-c1">0</span>] == <span class="pl-s1"><span class="pl-pds">"</span>Basic<span class="pl-pds">"</span></span>) {
        <span class="pl-k">return</span> <span class="pl-s1"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>, errors.<span class="pl-s3">New</span>(<span class="pl-s1"><span class="pl-pds">"</span>Invalid authentication<span class="pl-pds">"</span></span>)
    }

    <span class="pl-vo">decoded</span>, <span class="pl-vo">err</span> <span class="pl-k">:=</span> base64.<span class="pl-vo">StdEncoding</span>.<span class="pl-s3">DecodeString</span>(parts[<span class="pl-c1">1</span>])
    <span class="pl-k">if</span> err != <span class="pl-c1">nil</span> {
        <span class="pl-k">return</span> <span class="pl-s1"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>, errors.<span class="pl-s3">New</span>(<span class="pl-s1"><span class="pl-pds">"</span>Invalid base64<span class="pl-pds">"</span></span>)
    }

    <span class="pl-vo">creds</span> <span class="pl-k">:=</span> strings.<span class="pl-s3">SplitN</span>(<span class="pl-st">string</span>(decoded), <span class="pl-s1"><span class="pl-pds">"</span>:<span class="pl-pds">"</span></span>, <span class="pl-c1">2</span>)
    <span class="pl-k">if</span> <span class="pl-s3">len</span>(creds) != <span class="pl-c1">2</span> {
        <span class="pl-k">return</span> <span class="pl-s1"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>, errors.<span class="pl-s3">New</span>(<span class="pl-s1"><span class="pl-pds">"</span>Invalid authentication<span class="pl-pds">"</span></span>)
    }

    <span class="pl-k">return</span> creds[<span class="pl-c1">0</span>], creds[<span class="pl-c1">1</span>], <span class="pl-c1">nil</span>
}

<span class="pl-k">func</span> <span class="pl-en">main</span>() {

    <span class="pl-vo">handler</span> <span class="pl-k">:=</span> rest.<span class="pl-vo">ResourceHandler</span>{
        PreRoutingMiddlewares: []rest.<span class="pl-vo">Middleware</span>{
            &amp;MyAuthBasicMiddleware{
                Realm:    <span class="pl-s1"><span class="pl-pds">"</span>Administration<span class="pl-pds">"</span></span>,
                UserId:   <span class="pl-s1"><span class="pl-pds">"</span>admin<span class="pl-pds">"</span></span>,
                Password: <span class="pl-s1"><span class="pl-pds">"</span>admin<span class="pl-pds">"</span></span>,
            },
        },
    }
    <span class="pl-vo">err</span> <span class="pl-k">:=</span> handler.<span class="pl-s3">SetRoutes</span>(
        &amp;rest.<span class="pl-vo">Route</span>{<span class="pl-s1"><span class="pl-pds">"</span>GET<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>/countries<span class="pl-pds">"</span></span>, GetAllCountries},
    )
    <span class="pl-k">if</span> err != <span class="pl-c1">nil</span> {
        log.<span class="pl-s3">Fatal</span>(err)
    }
    log.<span class="pl-s3">Fatal</span>(http.<span class="pl-s3">ListenAndServe</span>(<span class="pl-s1"><span class="pl-pds">"</span>:8080<span class="pl-pds">"</span></span>, &amp;handler))
}

<span class="pl-k">type</span> <span class="pl-v">Country</span> <span class="pl-st">struct</span> {
    <span class="pl-v">Code</span> <span class="pl-st">string</span>
    <span class="pl-v">Name</span> <span class="pl-st">string</span>
}

<span class="pl-k">func</span> <span class="pl-en">GetAllCountries</span>(<span class="pl-v">w</span> <span class="pl-v">rest</span>.<span class="pl-v">ResponseWriter</span>, <span class="pl-v">r</span> *<span class="pl-v">rest</span>.<span class="pl-v">Request</span>) {
    w.<span class="pl-s3">WriteJson</span>(
        []Country{
            Country{
                Code: <span class="pl-s1"><span class="pl-pds">"</span>FR<span class="pl-pds">"</span></span>,
                Name: <span class="pl-s1"><span class="pl-pds">"</span>France<span class="pl-pds">"</span></span>,
            },
            Country{
                Code: <span class="pl-s1"><span class="pl-pds">"</span>US<span class="pl-pds">"</span></span>,
                Name: <span class="pl-s1"><span class="pl-pds">"</span>United States<span class="pl-pds">"</span></span>,
            },
        },
    )
}
</pre></div>

<h4>
<a id="cors-custom" class="anchor" href="#cors-custom" aria-hidden="true"><span class="octicon octicon-link"></span></a>CORS Custom</h4>

<p>Demonstrate how to implement a custom CORS middleware, used to on all endpoints.</p>

<p>The curl demo:</p>

<pre><code>curl -i http://127.0.0.1:8080/countries
</code></pre>

<p>Go code:</p>

<div class="highlight highlight-go"><pre><span class="pl-k">package</span> main

<span class="pl-k">import</span> (
    <span class="pl-s1"><span class="pl-pds">"</span>github.com/ant0ine/go-json-rest/rest<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>log<span class="pl-pds">"</span></span>
    <span class="pl-s1"><span class="pl-pds">"</span>net/http<span class="pl-pds">"</span></span>
)

<span class="pl-k">type</span> <span class="pl-v">MyCorsMiddleware</span> <span class="pl-st">struct</span>{}

<span class="pl-k">func</span> <span class="pl-en">(<span class="pl-v">mw</span> *<span class="pl-v">MyCorsMiddleware</span>) <span class="pl-en">MiddlewareFunc</span></span>(<span class="pl-v">handler</span> <span class="pl-v">rest</span>.<span class="pl-v">HandlerFunc</span>) <span class="pl-v">rest</span>.<span class="pl-v">HandlerFunc</span> {
    <span class="pl-k">return</span> <span class="pl-s3">func</span>(writer rest.<span class="pl-vo">ResponseWriter</span>, request *rest.<span class="pl-vo">Request</span>) {

        <span class="pl-vo">corsInfo</span> <span class="pl-k">:=</span> request.<span class="pl-s3">GetCorsInfo</span>()

        <span class="pl-c">// Be nice with non CORS requests, continue</span>
        <span class="pl-c">// Alternatively, you may also chose to only allow CORS requests, and return an error.</span>
        <span class="pl-k">if</span> !corsInfo.<span class="pl-vo">IsCors</span> {
            <span class="pl-c">// continure, execute the wrapped middleware</span>
            <span class="pl-s3">handler</span>(writer, request)
            <span class="pl-k">return</span>
        }

        <span class="pl-c">// Validate the Origin</span>
        <span class="pl-c">// More sophisticated validations can be implemented, regexps, DB lookups, ...</span>
        <span class="pl-k">if</span> corsInfo.<span class="pl-vo">Origin</span> != <span class="pl-s1"><span class="pl-pds">"</span>http://my.other.host<span class="pl-pds">"</span></span> {
            rest.<span class="pl-s3">Error</span>(writer, <span class="pl-s1"><span class="pl-pds">"</span>Invalid Origin<span class="pl-pds">"</span></span>, http.<span class="pl-vo">StatusForbidden</span>)
            <span class="pl-k">return</span>
        }

        <span class="pl-k">if</span> corsInfo.<span class="pl-vo">IsPreflight</span> {
            <span class="pl-c">// check the request methods</span>
            <span class="pl-vo">allowedMethods</span> <span class="pl-k">:=</span> <span class="pl-s">map</span>[<span class="pl-st">string</span>]<span class="pl-st">bool</span>{
                <span class="pl-s1"><span class="pl-pds">"</span>GET<span class="pl-pds">"</span></span>:  <span class="pl-c1">true</span>,
                <span class="pl-s1"><span class="pl-pds">"</span>POST<span class="pl-pds">"</span></span>: <span class="pl-c1">true</span>,
                <span class="pl-s1"><span class="pl-pds">"</span>PUT<span class="pl-pds">"</span></span>:  <span class="pl-c1">true</span>,
                <span class="pl-c">// don't allow DELETE, for instance</span>
            }
            <span class="pl-k">if</span> !allowedMethods[corsInfo.<span class="pl-vo">AccessControlRequestMethod</span>] {
                rest.<span class="pl-s3">Error</span>(writer, <span class="pl-s1"><span class="pl-pds">"</span>Invalid Preflight Request<span class="pl-pds">"</span></span>, http.<span class="pl-vo">StatusForbidden</span>)
                <span class="pl-k">return</span>
            }
            <span class="pl-c">// check the request headers</span>
            <span class="pl-vo">allowedHeaders</span> <span class="pl-k">:=</span> <span class="pl-s">map</span>[<span class="pl-st">string</span>]<span class="pl-st">bool</span>{
                <span class="pl-s1"><span class="pl-pds">"</span>Accept<span class="pl-pds">"</span></span>:          <span class="pl-c1">true</span>,
                <span class="pl-s1"><span class="pl-pds">"</span>Content-Type<span class="pl-pds">"</span></span>:    <span class="pl-c1">true</span>,
                <span class="pl-s1"><span class="pl-pds">"</span>X-Custom-Header<span class="pl-pds">"</span></span>: <span class="pl-c1">true</span>,
            }
            <span class="pl-k">for</span> <span class="pl-vo">_</span>, <span class="pl-vo">requestedHeader</span> <span class="pl-k">:=</span> <span class="pl-k">range</span> corsInfo.<span class="pl-vo">AccessControlRequestHeaders</span> {
                <span class="pl-k">if</span> !allowedHeaders[requestedHeader] {
                    rest.<span class="pl-s3">Error</span>(writer, <span class="pl-s1"><span class="pl-pds">"</span>Invalid Preflight Request<span class="pl-pds">"</span></span>, http.<span class="pl-vo">StatusForbidden</span>)
                    <span class="pl-k">return</span>
                }
            }

            <span class="pl-k">for</span> <span class="pl-vo">allowedMethod</span>, <span class="pl-vo">_</span> <span class="pl-k">:=</span> <span class="pl-k">range</span> allowedMethods {
                writer.<span class="pl-s3">Header</span>().<span class="pl-s3">Add</span>(<span class="pl-s1"><span class="pl-pds">"</span>Access-Control-Allow-Methods<span class="pl-pds">"</span></span>, allowedMethod)
            }
            <span class="pl-k">for</span> <span class="pl-vo">allowedHeader</span>, <span class="pl-vo">_</span> <span class="pl-k">:=</span> <span class="pl-k">range</span> allowedHeaders {
                writer.<span class="pl-s3">Header</span>().<span class="pl-s3">Add</span>(<span class="pl-s1"><span class="pl-pds">"</span>Access-Control-Allow-Headers<span class="pl-pds">"</span></span>, allowedHeader)
            }
            writer.<span class="pl-s3">Header</span>().<span class="pl-s3">Set</span>(<span class="pl-s1"><span class="pl-pds">"</span>Access-Control-Allow-Origin<span class="pl-pds">"</span></span>, corsInfo.<span class="pl-vo">Origin</span>)
            writer.<span class="pl-s3">Header</span>().<span class="pl-s3">Set</span>(<span class="pl-s1"><span class="pl-pds">"</span>Access-Control-Allow-Credentials<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>true<span class="pl-pds">"</span></span>)
            writer.<span class="pl-s3">Header</span>().<span class="pl-s3">Set</span>(<span class="pl-s1"><span class="pl-pds">"</span>Access-Control-Max-Age<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>3600<span class="pl-pds">"</span></span>)
            writer.<span class="pl-s3">WriteHeader</span>(http.<span class="pl-vo">StatusOK</span>)
            <span class="pl-k">return</span>
        } <span class="pl-k">else</span> {
            writer.<span class="pl-s3">Header</span>().<span class="pl-s3">Set</span>(<span class="pl-s1"><span class="pl-pds">"</span>Access-Control-Expose-Headers<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>X-Powered-By<span class="pl-pds">"</span></span>)
            writer.<span class="pl-s3">Header</span>().<span class="pl-s3">Set</span>(<span class="pl-s1"><span class="pl-pds">"</span>Access-Control-Allow-Origin<span class="pl-pds">"</span></span>, corsInfo.<span class="pl-vo">Origin</span>)
            writer.<span class="pl-s3">Header</span>().<span class="pl-s3">Set</span>(<span class="pl-s1"><span class="pl-pds">"</span>Access-Control-Allow-Credentials<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>true<span class="pl-pds">"</span></span>)
            <span class="pl-c">// continure, execute the wrapped middleware</span>
            <span class="pl-s3">handler</span>(writer, request)
            <span class="pl-k">return</span>
        }
    }
}

<span class="pl-k">func</span> <span class="pl-en">main</span>() {

    <span class="pl-vo">handler</span> <span class="pl-k">:=</span> rest.<span class="pl-vo">ResourceHandler</span>{
        PreRoutingMiddlewares: []rest.<span class="pl-vo">Middleware</span>{
            &amp;MyCorsMiddleware{},
        },
    }
    <span class="pl-vo">err</span> <span class="pl-k">:=</span> handler.<span class="pl-s3">SetRoutes</span>(
        &amp;rest.<span class="pl-vo">Route</span>{<span class="pl-s1"><span class="pl-pds">"</span>GET<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>/countries<span class="pl-pds">"</span></span>, GetAllCountries},
    )
    <span class="pl-k">if</span> err != <span class="pl-c1">nil</span> {
        log.<span class="pl-s3">Fatal</span>(err)
    }
    log.<span class="pl-s3">Fatal</span>(http.<span class="pl-s3">ListenAndServe</span>(<span class="pl-s1"><span class="pl-pds">"</span>:8080<span class="pl-pds">"</span></span>, &amp;handler))
}

<span class="pl-k">type</span> <span class="pl-v">Country</span> <span class="pl-st">struct</span> {
    <span class="pl-v">Code</span> <span class="pl-st">string</span>
    <span class="pl-v">Name</span> <span class="pl-st">string</span>
}

<span class="pl-k">func</span> <span class="pl-en">GetAllCountries</span>(<span class="pl-v">w</span> <span class="pl-v">rest</span>.<span class="pl-v">ResponseWriter</span>, <span class="pl-v">r</span> *<span class="pl-v">rest</span>.<span class="pl-v">Request</span>) {
    w.<span class="pl-s3">WriteJson</span>(
        []Country{
            Country{
                Code: <span class="pl-s1"><span class="pl-pds">"</span>FR<span class="pl-pds">"</span></span>,
                Name: <span class="pl-s1"><span class="pl-pds">"</span>France<span class="pl-pds">"</span></span>,
            },
            Country{
                Code: <span class="pl-s1"><span class="pl-pds">"</span>US<span class="pl-pds">"</span></span>,
                Name: <span class="pl-s1"><span class="pl-pds">"</span>United States<span class="pl-pds">"</span></span>,
            },
        },
    )
}
</pre></div>

<h2>
<a id="external-documentation" class="anchor" href="#external-documentation" aria-hidden="true"><span class="octicon octicon-link"></span></a>External Documentation</h2>

<ul>
<li><a href="http://godoc.org/github.com/ant0ine/go-json-rest/rest">Online Documentation (godoc.org)</a></li>
</ul>

<p>Old v1 blog posts:</p>

<ul>
<li><a href="http://blog.ant0ine.com/typepad/2013/04/introducing-go-json-rest.html">(Blog Post) Introducing Go-Json-Rest</a></li>
<li><a href="http://blog.ant0ine.com/typepad/2013/02/better-url-routing-golang-1.html">(Blog Post) Better URL Routing ?</a></li>
</ul>

<h2>
<a id="options" class="anchor" href="#options" aria-hidden="true"><span class="octicon octicon-link"></span></a>Options</h2>

<p>Things to enable in production:</p>

<ul>
<li>Gzip compression (default: disabled)</li>
<li>Custom Logger (default: Go default)</li>
</ul>

<p>Things to enable in development:</p>

<ul>
<li>Json indentation (default: enabled)</li>
<li>Relaxed ContentType (default: disabled)</li>
<li>Error stack trace in the response body (default: disabled)</li>
</ul>

<h2>
<a id="version-2-release-notes" class="anchor" href="#version-2-release-notes" aria-hidden="true"><span class="octicon octicon-link"></span></a>Version 2 release notes</h2>

<ul>
<li><p>Middlewares, the notion of middleware is now formally defined. They can be setup as global pre-routing Middlewares wrapping all the endpoints, or on a per endpoint basis.
In fact the internal code of <strong>go-json-rest</strong> is itself implemented with Middlewares, they are just hidden behind configuration boolean flags to make these very common options even easier to use.</p></li>
<li><p>A new ResponseWriter. This is now an interface, and allows Middlewares to wrap the writer. The provided writer implements, in addition of <em>rest.ResponseWriter</em>, <em>http.Flusher</em>, <em>http.CloseNotifier</em>, <em>http.Hijacker</em>, and <em>http.ResponseWriter</em>. A lot more Go-ish, and very similar to <code>net/http</code>.</p></li>
<li><p>The AuthBasic and CORS Middlewares have been added. More to come in the future.</p></li>
<li><p>Faster, more tasks are performed at init time, and less for each request.</p></li>
<li><p>New documentation, with more examples.</p></li>
<li><p>A lot of other small improvements, See the <a href="#migration-guide-from-v1-to-v2">Migration guide to v2</a></p></li>
</ul>

<h2>
<a id="migration-guide-from-v1-to-v2" class="anchor" href="#migration-guide-from-v1-to-v2" aria-hidden="true"><span class="octicon octicon-link"></span></a>Migration guide from v1 to v2</h2>

<p><strong>Go-Json-Rest</strong> follows <a href="http://semver.org/">Semver</a> and a few breaking changes have been introduced with the v2.</p>

<h4>
<a id="the-import-path-has-changed-to-githubcomant0inego-json-restrest" class="anchor" href="#the-import-path-has-changed-to-githubcomant0inego-json-restrest" aria-hidden="true"><span class="octicon octicon-link"></span></a>The import path has changed to <code>github.com/ant0ine/go-json-rest/rest</code>
</h4>

<p>This is more conform to Go style, and makes <a href="https://godoc.org/code.google.com/p/go.tools/cmd/goimports">goimports</a> work.</p>

<p>This:</p>

<div class="highlight highlight-go"><pre><span class="pl-k">import</span> (
        <span class="pl-s1"><span class="pl-pds">"</span>github.com/ant0ine/go-json-rest<span class="pl-pds">"</span></span>
)</pre></div>

<p>has to be changed to this:</p>

<div class="highlight highlight-go"><pre><span class="pl-k">import</span> (
        <span class="pl-s1"><span class="pl-pds">"</span>github.com/ant0ine/go-json-rest/rest<span class="pl-pds">"</span></span>
)</pre></div>

<h4>
<a id="restresponsewriter-is-now-an-interface" class="anchor" href="#restresponsewriter-is-now-an-interface" aria-hidden="true"><span class="octicon octicon-link"></span></a>rest.ResponseWriter is now an interface</h4>

<p>This change allows the <code>ResponseWriter</code> to be wrapped, like the one of the <code>net/http</code> package.
This is much more powerful, and allows the creation of Middlewares that wrap the writer. The gzip option, for instance, uses this to encode the payload (see gzip.go).</p>

<p>This:</p>

<div class="highlight highlight-go"><pre><span class="pl-k">func</span> (<span class="pl-v">w</span> *<span class="pl-v">rest</span>.<span class="pl-v">ResponseWriter</span>, <span class="pl-v">req</span> *<span class="pl-v">rest</span>.<span class="pl-v">Request</span>) {
        ...
}</pre></div>

<p>has to be changed to this:</p>

<div class="highlight highlight-go"><pre><span class="pl-k">func</span> (<span class="pl-v">w</span> <span class="pl-v">rest</span>.<span class="pl-v">ResponseWriter</span>, <span class="pl-v">req</span> *<span class="pl-v">rest</span>.<span class="pl-v">Request</span>) {
        ...
}</pre></div>

<h4>
<a id="setroutes-now-takes-pointers-to-route" class="anchor" href="#setroutes-now-takes-pointers-to-route" aria-hidden="true"><span class="octicon octicon-link"></span></a>SetRoutes now takes pointers to Route</h4>

<p>Instead of copying Route structures everywhere, pointers are now used. This is more elegant, more efficient, and will allow more sophisticated Route manipulations in the future (like reverse route resolution).</p>

<p>This:</p>

<div class="highlight highlight-go"><pre>handler.<span class="pl-s3">SetRoutes</span>(
        rest.<span class="pl-vo">Route</span>{
              <span class="pl-c">// ...</span>
        },
)</pre></div>

<p>has to be changed to this:</p>

<div class="highlight highlight-go"><pre>handler.<span class="pl-s3">SetRoutes</span>(
        &amp;rest.<span class="pl-vo">Route</span>{
              <span class="pl-c">// ...</span>
        },
)</pre></div>

<h4>
<a id="the-notion-of-middleware-is-now-formally-defined" class="anchor" href="#the-notion-of-middleware-is-now-formally-defined" aria-hidden="true"><span class="octicon octicon-link"></span></a>The notion of Middleware is now formally defined</h4>

<p>A middleware is an object satisfying this interface:</p>

<div class="highlight highlight-go"><pre><span class="pl-k">type</span> <span class="pl-v">Middleware</span> <span class="pl-k">interface</span> {
    <span class="pl-s3">MiddlewareFunc</span>(handler <span class="pl-v">HandlerFunc</span>) <span class="pl-v">HandlerFunc</span>
}</pre></div>

<p>Code using PreRoutingMiddleware will have to be adapted to provide a list of Middleware objects.
See the <a href="https://github.com/ant0ine/go-json-rest-examples/blob/master/auth-basic/main.go">Basic Auth example</a>.</p>

<h4>
<a id="flush-closenotify-and-write-are-not-directly-exposed-anymore" class="anchor" href="#flush-closenotify-and-write-are-not-directly-exposed-anymore" aria-hidden="true"><span class="octicon octicon-link"></span></a>Flush(), CloseNotify() and Write() are not directly exposed anymore</h4>

<p>They used to be public methods of the ResponseWriter. The implementation is still there but a type assertion of the corresponding interface is now necessary.
Regarding these features, a rest.ResponseWriter now behaves exactly as the http.ResponseWriter implementation provided by net/http.</p>

<p>This:</p>

<div class="highlight highlight-go"><pre>writer.<span class="pl-s3">Flush</span>()</pre></div>

<p>has to be changed to this:</p>

<div class="highlight highlight-go"><pre>writer.(http.<span class="pl-vo">Flusher</span>).<span class="pl-s3">Flush</span>()</pre></div>

<h4>
<a id="the-status-endpoint-is-not-created-automatically-anymore" class="anchor" href="#the-status-endpoint-is-not-created-automatically-anymore" aria-hidden="true"><span class="octicon octicon-link"></span></a>The /.status endpoint is not created automatically anymore</h4>

<p>The route has to be manually defined.
See the <a href="https://github.com/ant0ine/go-json-rest-examples/blob/master/status/main.go">Status example</a>.
This is more flexible (the route is customizable), and allows combination with Middlewarres.
See for instance how to <a href="https://github.com/ant0ine/go-json-rest-examples/blob/master/status-auth/main.go">protect this status endpoint with the AuthBasic middleware</a>.</p>

<h4>
<a id="request-utility-methods-have-changed" class="anchor" href="#request-utility-methods-have-changed" aria-hidden="true"><span class="octicon octicon-link"></span></a>Request utility methods have changed</h4>

<p>Overall, they provide the same features, but with two methods instead of three, better names, and without the confusing <code>UriForWithParams</code>.</p>

<ul>
<li><p><code>func (r *Request) UriBase() url.URL</code> is now <code>func (r *Request) BaseUrl() *url.URL</code>, Note the pointer as the returned value.</p></li>
<li><p><code>func (r *Request) UriForWithParams(path string, parameters map[string][]string) url.URL</code> is now <code>func (r *Request) UrlFor(path string, queryParams map[string][]string) *url.URL</code>.</p></li>
<li><p><code>func (r *Request) UriFor(path string) url.URL</code> has be removed.</p></li>
</ul>

<h2>
<a id="thanks" class="anchor" href="#thanks" aria-hidden="true"><span class="octicon octicon-link"></span></a>Thanks</h2>

<ul>
<li><a href="https://github.com/franckcuny">Franck Cuny</a></li>
<li><a href="https://github.com/yannk">Yann Kerherv</a></li>
<li><a href="https://github.com/abh">Ask Bjrn Hansen</a></li>
<li><a href="https://github.com/Quantisan">Paul Lam</a></li>
</ul>

<p>Copyright (c) 2013-2014 Antoine Imbert</p>

<p><a href="https://github.com/ant0ine/go-json-rest/blob/master/LICENSE">MIT License</a></p>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Go-json-rest maintained by <a href="https://github.com/ant0ine">ant0ine</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

              <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-309210-5");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>


  </body>
</html>
